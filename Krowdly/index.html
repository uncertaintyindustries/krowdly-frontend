<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krowdly | Connect & Explore</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
:root{
  --primary:#6c63ff;
  --secondary:#9b72f9;
  --bg:#f4f6fb;
}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:var(--bg);
  color:#333;
}

header{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:white;
  padding:60px 20px;
  text-align:center;
  border-bottom-left-radius:30px;
  border-bottom-right-radius:30px;
}

#authBtn{
  position:fixed;
  top:20px;
  right:20px;
  background:white;
  color:var(--primary);
  padding:10px 20px;
  border-radius:12px;
  font-weight:bold;
  border:none;
  cursor:pointer;
  box-shadow:0 5px 20px rgba(0,0,0,0.15);
  z-index:1000;
}

section{
  background:white;
  max-width:1100px;
  margin:25px auto;
  padding:25px;
  border-radius:16px;
  box-shadow:0 5px 20px rgba(0,0,0,0.05);
}

input,select,button{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:1rem;
}

button{
  background:var(--primary);
  color:white;
  font-weight:bold;
  border:none;
  cursor:pointer;
  transition:0.2s;
}

button:hover{
  transform:translateY(-2px);
  opacity:0.9;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
}

.event-card{
  padding:20px;
  border-radius:14px;
  border:1px solid #eee;
  transition:0.3s;
}

.event-card:hover{
  transform:translateY(-5px);
  box-shadow:0 10px 25px rgba(0,0,0,0.1);
}

.tag{
  background:#f0edff;
  color:var(--primary);
  padding:5px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:bold;
}

.user-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-top:12px;
}

.user-row img{
  width:32px;
  height:32px;
  border-radius:50%;
  margin-right:10px;
}

#map{
  height:400px;
  border-radius:16px;
}

#chatBox{
  height:250px;
  overflow-y:auto;
  background:#f9f9f9;
  padding:10px;
  border-radius:12px;
}

footer {
  text-align: center;
  padding: 20px;
  background: #f4f6fb;
  color: #666;
  font-size: 0.9rem;
  border-top: 1px solid #ddd;
  margin-top: 40px;
}
</style>
</head>
<body>

<button id="authBtn">Login</button>

<header>
<h1>ðŸŽ‰ Krowdly</h1>
<p>Discover. Host. Connect.</p>
</header>

<section id="createSection" style="display:none;">
<h2>Create Event</h2>
<input id="eventName" placeholder="Event Name">
<input id="eventLocation" placeholder="Location">
<select id="eventCategory">
<option>Music</option>
<option>Tech</option>
<option>Food</option>
<option>Jobs</option>
<option>Social</option>
</select>
<select id="eventPrivacy">
<option value="public">Public</option>
<option value="private">Private</option>
</select>
<input type="file" id="eventImage">
<button onclick="createEvent()">Post Event</button>
</section>

<section>
<h2>Live Map</h2>
<div id="map"></div>
</section>

<section>
<h2>Nearby Events</h2>
<div class="grid" id="eventGrid"></div>
</section>

<section id="chatSection" style="display:none;">
<h2>Real-Time Chat</h2>
<select id="chatUserSelect"></select>
<div id="chatBox"></div>
<input id="chatInput" placeholder="Type message...">
<button onclick="sendMessage()">Send</button>
</section>

<footer>
  Â© 2026 Krowdly | Parent Company: Uncertainty Industries | All rights reserved | Otubu Christopher
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module" src="./chat.js"></script>

<script>
const BACKEND="https://krowdly.vercel.app"; // âœ… set to your Vercel project URL
let currentUser=null;
let socket=null;
let markers=[];
const map=L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function getToken(){ return localStorage.getItem("krowdly_token"); }
function authFetch(url,opt={}){ opt.headers={...(opt.headers||{}),"Authorization":"Bearer "+getToken()}; return fetch(url,opt); }

document.getElementById("authBtn").onclick=async()=>{
  if(currentUser){ localStorage.removeItem("krowdly_token"); location.reload(); }
  const username=prompt("Enter demo name:");
  const res=await fetch(BACKEND+"/api/auth",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ googleId:Math.random().toString(36), username, email:username+"@demo.com", photoURL:"https://picsum.photos/50" })
  });
  const data=await res.json();
  localStorage.setItem("krowdly_token",data.token);
  currentUser=data.user;
  initAfterLogin();
};

function initAfterLogin(){
  document.getElementById("authBtn").innerText="Logout";
  document.getElementById("createSection").style.display="block";
  document.getElementById("chatSection").style.display="block";
  connectSocket();
  loadEvents();
  loadUsers();
}

function connectSocket(){
  socket=io(BACKEND,{auth:{token:getToken()}});
  socket.on("receive_message",msg=>{ addMessage(msg.text,false); });
}

function addMessage(text,isMine){
  const div=document.createElement("div");
  div.style.textAlign=isMine?"right":"left";
  div.textContent=text;
  document.getElementById("chatBox").appendChild(div);
}

function sendMessage(){
  const text=document.getElementById("chatInput").value;
  const to=document.getElementById("chatUserSelect").value;
  if(!text) return;
  socket.emit("send_message",{to,text});
  addMessage(text,true);
  document.getElementById("chatInput").value="";
}

async function loadUsers(){
  const res=await authFetch(BACKEND+"/api/users");
  const users=await res.json();
  const select=document.getElementById("chatUserSelect");
  select.innerHTML="";
  users.filter(u=>u._id!==currentUser.id)
       .forEach(u=>{
         const opt=document.createElement("option");
         opt.value=u._id;
         opt.textContent=u.username;
         select.appendChild(opt);
       });
}

async function createEvent(){
  navigator.geolocation.getCurrentPosition(async pos=>{
    const name=document.getElementById("eventName").value;
    const location=document.getElementById("eventLocation").value;
    const category=document.getElementById("eventCategory").value;
    const privacy=document.getElementById("eventPrivacy").value;
    await authFetch(BACKEND+"/api/events",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        name,location,category,privacy,
        lat:pos.coords.latitude,
        lon:pos.coords.longitude
      })
    });
    loadEvents();
  });
}

async function loadEvents(){
  const res=await fetch(BACKEND+"/api/events");
  const events=await res.json();
  const grid=document.getElementById("eventGrid");
  grid.innerHTML="";
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  events.forEach(e=>{
    const card=document.createElement("div");
    card.className="event-card";
    card.innerHTML=`
      <span class="tag">${e.category}</span>
      <h3>${e.name}</h3>
      <p>${e.location}</p>
      <div class="user-row">
        <div style="display:flex;align-items:center;">
          <img src="${e.creator.photoURL}">
          <span>${e.creator.username}</span>
        </div>
        <button onclick="toggleFollow('${e.creator._id}',this)">Follow</button>
      </div>
    `;
    grid.appendChild(card);
    const marker=L.marker([e.lat,e.lon]).addTo(map)
                  .bindPopup("<b>"+e.name+"</b><br>"+e.location);
    markers.push(marker);
  });
}

async function toggleFollow(id,btn){
  const action=btn.innerText==="Follow"?"follow":"unfollow";
  await authFetch(BACKEND+"/api/users/"+id+"/"+action,{method:"POST"});
  btn.innerText=action==="follow"?"Unfollow":"Follow";
}

if(getToken()){
  fetch(BACKEND+"/api/auth",{headers:{Authorization:"Bearer "+getToken()}})
    .then(r=>r.json())
    .then(user=>{ currentUser=user; initAfterLogin(); });
}
</script>

</body>
</html>