<!DOCTYPE html>
<html lang="en" data-theme="vibrant">
<head>
<meta charset="UTF-8">
<title>Krowdly — Where Your Squad Hangs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 110 110'><ellipse cx='40' cy='28' rx='15' ry='24' transform='rotate(-35 40 28)' fill='%23ff2d95'/><ellipse cx='68' cy='22' rx='15' ry='24' transform='rotate(25 68 22)' fill='%23f97316'/><ellipse cx='20' cy='58' rx='15' ry='24' transform='rotate(-65 20 58)' fill='%23fbbf24'/><ellipse cx='36' cy='80' rx='15' ry='24' transform='rotate(-15 36 80)' fill='%2310b981'/><ellipse cx='64' cy='86' rx='15' ry='24' transform='rotate(20 64 86)' fill='%2306b6d4'/><ellipse cx='90' cy='58' rx='15' ry='24' transform='rotate(65 90 58)' fill='%233b82f6'/><ellipse cx='76' cy='32' rx='14' ry='22' transform='rotate(10 76 32)' fill='%23a855f7'/><ellipse cx='52' cy='50' rx='12' ry='18' fill='rgba(230,180,255,0.7)'/></svg>" type="image/svg+xml">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,700;0,9..144,900;1,9..144,700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- Supabase JS (handles real-time WebSocket — replaces Socket.io, works on Vercel) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
/* ─────────────────────────────────────────
   ROOT VARIABLES
───────────────────────────────────────── */
:root {
  --pk: #ff2d95; --pu: #a855f7; --bl: #3b82f6;
  --cy: #06b6d4; --gr: #10b981; --ye: #fbbf24; --or: #f97316;
  --g1: linear-gradient(135deg,#ff2d95,#f97316);
  --g2: linear-gradient(135deg,#a855f7,#3b82f6);
  --g3: linear-gradient(135deg,#06b6d4,#10b981);
  --g4: linear-gradient(135deg,#fbbf24,#f97316);
  --gR: linear-gradient(90deg,#ff2d95,#a855f7,#3b82f6,#06b6d4,#10b981,#fbbf24);
  --bg:#fef3ff; --bg2:#fce7fe; --bg3:#f5d0fe;
  --sur:#fff; --ink:#1e1b4b; --ink2:#4c1d95; --ink3:#7c3aed; --ink4:#a78bfa;
  --sb-bg:linear-gradient(180deg,#1a0b2e,#0f0520);
  --sb-bdr:rgba(255,255,255,0.1); --sb-tx:rgba(255,255,255,0.6);
  --sb-tx2:rgba(255,255,255,0.9); --sb-hv:rgba(255,45,149,0.15);
  --r1:10px; --r2:16px; --r3:22px; --r4:30px; --rF:999px;
  --sh1:0 2px 8px rgba(168,85,247,0.1);
  --sh2:0 8px 32px rgba(168,85,247,0.15);
  --sh3:0 20px 60px rgba(168,85,247,0.2);
  --glow:0 0 20px rgba(255,45,149,0.4);
  --T:all 0.28s cubic-bezier(0.4,0,0.2,1);
  --sw:290px;
}
[data-theme="dark"] {
  --bg:#0d0118; --bg2:#150928; --bg3:#2a1245;
  --sur:#150928; --ink:#f0e6ff; --ink2:#d8b4fe; --ink3:#c084fc; --ink4:#a855f7;
  --sh1:0 2px 8px rgba(0,0,0,0.5); --sh2:0 8px 32px rgba(0,0,0,0.6); --sh3:0 20px 60px rgba(0,0,0,0.7);
}
[data-theme="dark"] #topbar { background:rgba(13,1,24,0.9); border-bottom-color:var(--bg3); }
[data-theme="dark"] .field input,[data-theme="dark"] .field select,[data-theme="dark"] .field textarea,
[data-theme="dark"] #searchInput,[data-theme="dark"] #chatInput { background:var(--bg2);color:var(--ink);border-color:var(--bg3); }
[data-theme="dark"] .ec-footer,[data-theme="dark"] .sc-head,[data-theme="dark"] .chat-top,
[data-theme="dark"] .chat-inp-row,[data-theme="dark"] #chatBox,[data-theme="dark"] #activityPanel,
[data-theme="dark"] .cp-head,[data-theme="dark"] #chatUserList { background:var(--bg2); }
[data-theme="dark"] .msg.theirs { background:var(--bg3);border-color:var(--bg3);color:var(--ink); }
[data-theme="dark"] #chat-popout { background:var(--bg2);border-color:var(--bg3); }
[data-theme="dark"] .cui:hover,[data-theme="dark"] .cui.active { background:var(--bg3); }
[data-theme="dark"] .profile-card { background:var(--bg2);border-color:var(--bg3); }
[data-theme="dark"] .ev-img-placeholder { background:var(--bg3); }

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{font-size:16px;-webkit-font-smoothing:antialiased;}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--ink);min-height:100vh;display:flex;overflow-x:hidden;position:relative;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 20% 30%,rgba(255,45,149,0.07) 0%,transparent 50%),radial-gradient(circle at 80% 70%,rgba(168,85,247,0.07) 0%,transparent 50%);pointer-events:none;z-index:0;animation:bgPulse 15s ease-in-out infinite;}
@keyframes bgPulse{0%,100%{opacity:1;}50%{opacity:0.5;}}

/* ─────────────────────────────────────────
   SIDEBAR POPOUT
───────────────────────────────────────── */
#sb-overlay{position:fixed;inset:0;background:rgba(10,0,20,0.7);backdrop-filter:blur(6px);z-index:398;opacity:0;pointer-events:none;transition:opacity 0.3s ease;}
#sb-overlay.vis{opacity:1;pointer-events:all;}
#sidebar{width:var(--sw);height:100vh;background:var(--sb-bg);position:fixed;top:0;left:0;display:flex;flex-direction:column;z-index:400;overflow:hidden;box-shadow:6px 0 40px rgba(168,85,247,0.4);transform:translateX(-100%);transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);}
#sidebar.open{transform:translateX(0);}
#sidebar::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gR);animation:rbSlide 8s linear infinite;background-size:200% 100%;z-index:10;}
@keyframes rbSlide{to{background-position:200% 0;}}
#sidebar::after{content:'';position:absolute;top:40%;left:50%;width:260px;height:260px;background:radial-gradient(circle,rgba(255,45,149,0.25) 0%,transparent 70%);border-radius:50%;filter:blur(50px);animation:orbF 8s ease-in-out infinite;pointer-events:none;}
@keyframes orbF{0%,100%{transform:translate(-50%,-50%) scale(1);}50%{transform:translate(-60%,-40%) scale(1.2);}}

.sb-head{padding:20px 18px;border-bottom:1px solid var(--sb-bdr);flex-shrink:0;position:relative;z-index:2;background:rgba(0,0,0,0.25);display:flex;align-items:center;justify-content:space-between;}
.logo-row{display:flex;align-items:center;gap:11px;}
.logo-word{font-family:'Fraunces',serif;font-size:1.55rem;font-weight:900;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.5px;}
.sb-x{width:32px;height:32px;border-radius:var(--r2);background:rgba(255,255,255,0.08);border:1px solid var(--sb-bdr);color:rgba(255,255,255,0.5);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;transition:var(--T);}
.sb-x:hover{background:var(--pk);color:#fff;border-color:transparent;transform:rotate(90deg);}

.sb-nav{flex:1;overflow-y:auto;padding:14px 10px;position:relative;z-index:2;scrollbar-width:thin;scrollbar-color:rgba(255,45,149,0.3) transparent;}
.sb-nav::-webkit-scrollbar{width:4px;}.sb-nav::-webkit-scrollbar-thumb{background:rgba(255,45,149,0.3);border-radius:10px;}
.sb-label{font-size:0.6rem;font-weight:800;letter-spacing:2.5px;text-transform:uppercase;color:var(--sb-tx);padding:18px 12px 6px;display:flex;align-items:center;gap:6px;opacity:0.7;}
.sb-label::before{content:'✦';font-size:0.7rem;color:var(--pk);}
.ni{display:flex;align-items:center;gap:11px;padding:11px 13px;border-radius:var(--r2);cursor:pointer;font-size:0.88rem;font-weight:600;color:var(--sb-tx2);transition:var(--T);border:none;background:none;width:100%;text-align:left;position:relative;margin-bottom:3px;font-family:'Outfit',sans-serif;}
.ni:hover{background:var(--sb-hv);color:#fff;transform:translateX(3px);}
.ni.active{background:var(--g2);color:#fff;box-shadow:var(--glow);}
.ni-ic{width:18px;height:18px;flex-shrink:0;opacity:0.9;}
.ni-badge{margin-left:auto;background:var(--g1);color:white;font-family:'DM Mono',monospace;font-size:0.62rem;font-weight:500;padding:2px 7px;border-radius:var(--rF);display:none;}

/* Category strip */
.cat-strip{display:flex;flex-direction:column;gap:3px;}
.ci{display:flex;align-items:center;gap:9px;padding:9px 13px;border-radius:var(--r2);cursor:pointer;font-size:0.83rem;font-weight:600;color:var(--sb-tx2);transition:var(--T);border:none;background:none;width:100%;text-align:left;}
.ci:hover{background:var(--sb-hv);color:#fff;transform:translateX(3px);}
.ci.active{color:#fff;background:rgba(168,85,247,0.25);box-shadow:0 4px 16px rgba(168,85,247,0.3);}
.cdot{width:9px;height:9px;border-radius:50%;flex-shrink:0;animation:dotP 2s ease-in-out infinite;}
@keyframes dotP{0%,100%{transform:scale(1);}50%{transform:scale(1.15);}}
.cat-del{margin-left:auto;opacity:0;font-size:0.8rem;color:rgba(255,255,255,0.4);transition:var(--T);background:none;border:none;cursor:pointer;padding:0 4px;line-height:1;}
.ci:hover .cat-del{opacity:1;}
.ci:hover .cat-del:hover{color:var(--pk);}
.cat-add{display:flex;align-items:center;gap:9px;padding:9px 13px;border-radius:var(--r2);cursor:pointer;font-size:0.83rem;font-weight:600;color:var(--sb-tx2);transition:var(--T);border:2px dashed rgba(255,255,255,0.18);background:none;width:100%;margin-top:6px;font-family:'Outfit',sans-serif;}
.cat-add:hover{border-color:var(--pk);color:var(--pk);background:rgba(255,45,149,0.08);}
.cnf{display:none;flex-direction:column;gap:9px;padding:13px;background:rgba(255,255,255,0.07);border-radius:var(--r2);margin-top:6px;border:1px solid var(--sb-bdr);}
.cnf.open{display:flex;}
.cnf input{padding:9px 12px;border-radius:var(--r1);border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);font-family:'Outfit',sans-serif;font-size:0.88rem;font-weight:500;color:#fff;outline:none;transition:var(--T);}
.cnf input:focus{border-color:var(--pk);box-shadow:0 0 0 3px rgba(255,45,149,0.2);}
.cnf input::placeholder{color:rgba(255,255,255,0.35);}
.sw-row{display:flex;gap:7px;flex-wrap:wrap;}
.sw{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:var(--T);flex-shrink:0;background:none;}
.sw:hover,.sw.sel{border-color:#fff;transform:scale(1.3);box-shadow:0 0 14px currentColor;}
.cnf-acts{display:flex;gap:7px;}

/* ── Profile card in sidebar ── */
.sb-foot{padding:14px 10px;border-top:1px solid var(--sb-bdr);flex-shrink:0;position:relative;z-index:2;background:rgba(0,0,0,0.2);}
.profile-card{background:rgba(255,255,255,0.07);border:1px solid var(--sb-bdr);border-radius:var(--r3);padding:16px;display:flex;flex-direction:column;gap:12px;}
.pc-top{display:flex;align-items:center;gap:12px;}
.pc-av{width:46px;height:46px;border-radius:50%;object-fit:cover;border:3px solid transparent;background:var(--g1);flex-shrink:0;box-shadow:0 0 18px rgba(255,45,149,0.5);}
.pc-info{flex:1;min-width:0;}
.pc-name{font-size:0.92rem;font-weight:800;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pc-tag{font-size:0.68rem;color:var(--cy);margin-top:2px;font-weight:600;display:flex;align-items:center;gap:5px;}
.pc-actions{display:flex;gap:8px;}
.pc-btn{flex:1;padding:8px;border-radius:var(--r1);border:1px solid var(--sb-bdr);background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.7);font-size:0.72rem;font-weight:700;cursor:pointer;transition:var(--T);font-family:'Outfit',sans-serif;text-align:center;letter-spacing:0.3px;}
.pc-btn:hover{background:var(--g1);color:#fff;border-color:transparent;}
.pc-btn.danger:hover{background:linear-gradient(135deg,#ef4444,#dc2626);}
.sb-guest-row{display:flex;align-items:center;justify-content:space-between;padding:8px 4px;}
.sb-guest-txt{font-size:0.78rem;color:var(--sb-tx);font-weight:500;}
.theme-btn{width:34px;height:34px;border-radius:var(--r1);border:1px solid var(--sb-bdr);background:rgba(255,255,255,0.08);color:var(--sb-tx2);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--T);flex-shrink:0;}
.theme-btn:hover{background:var(--g1);color:#fff;transform:rotate(20deg) scale(1.1);border-color:transparent;}

/* ─────────────────────────────────────────
   CHAT POPOUT
───────────────────────────────────────── */
#chat-popout{width:310px;height:100vh;background:var(--sur);border-left:2px solid var(--bg3);position:fixed;top:0;right:0;z-index:399;display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);box-shadow:-4px 0 30px rgba(168,85,247,0.18);}
#chat-popout.open{transform:translateX(0);}
.cp-head{padding:0 16px;border-bottom:2px solid var(--bg3);background:var(--bg);flex-shrink:0;}
.cp-toprow{display:flex;align-items:center;justify-content:space-between;padding:14px 0 10px;}
.cp-title{font-size:0.8rem;font-weight:800;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:1.5px;text-transform:uppercase;}
.cp-x{width:30px;height:30px;border-radius:var(--r1);border:2px solid var(--bg3);background:var(--sur);color:var(--ink3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.9rem;transition:var(--T);}
.cp-x:hover{background:var(--pk);color:#fff;border-color:transparent;transform:rotate(90deg);}
.cp-tabs{display:flex;}
.cp-tab{padding:9px 14px 11px;font-size:0.75rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink4);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;background:none;border-top:none;border-left:none;border-right:none;font-family:'Outfit',sans-serif;transition:var(--T);}
.cp-tab:hover{color:var(--ink2);}
.cp-tab.active{color:var(--pu);border-bottom-color:var(--pu);}
#chatUserList{padding:8px;border-bottom:2px solid var(--bg3);display:flex;flex-direction:column;gap:2px;max-height:190px;overflow-y:auto;flex-shrink:0;}
.cui{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:var(--r2);cursor:pointer;font-size:0.83rem;font-weight:700;color:var(--ink);transition:var(--T);position:relative;border:none;background:none;width:100%;text-align:left;}
.cui:hover,.cui.active{background:var(--bg2);}
.cui img{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--bg3);flex-shrink:0;}
.cui-dot{width:9px;height:9px;background:var(--gr);border-radius:50%;position:absolute;bottom:8px;left:36px;border:2px solid var(--sur);box-shadow:0 0 8px var(--gr);}
.cu-badge{margin-left:auto;background:var(--g1);color:white;font-family:'DM Mono',monospace;font-size:0.62rem;font-weight:500;padding:1px 7px;border-radius:var(--rF);}
.chat-top{padding:11px 16px;background:var(--bg);border-bottom:2px solid var(--bg3);font-size:0.83rem;font-weight:800;color:var(--ink);display:flex;align-items:center;gap:7px;flex-shrink:0;}
#chatBox{flex:1;overflow-y:auto;padding:16px 12px;display:flex;flex-direction:column;gap:9px;background:var(--bg);scroll-behavior:smooth;}
.msg{padding:10px 13px;border-radius:var(--r2);max-width:86%;font-size:0.86rem;line-height:1.6;word-break:break-word;animation:msgP 0.28s cubic-bezier(0.4,0,0.2,1) both;font-weight:500;}
@keyframes msgP{from{opacity:0;transform:scale(.92) translateY(8px);}to{opacity:1;transform:scale(1) translateY(0);}}
.msg.mine{align-self:flex-end;background:var(--g1);color:#fff;border-bottom-right-radius:3px;box-shadow:0 4px 14px rgba(255,45,149,0.28);}
.msg.theirs{align-self:flex-start;background:var(--sur);color:var(--ink);border:2px solid var(--bg3);border-bottom-left-radius:3px;}
.msg-sender{font-size:0.66rem;font-weight:800;margin-bottom:3px;opacity:0.65;text-transform:uppercase;letter-spacing:0.5px;}
.msg-time{font-family:'DM Mono',monospace;font-size:0.62rem;opacity:0.45;margin-top:3px;text-align:right;}
.typing-ind{align-self:flex-start;background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r2);border-bottom-left-radius:3px;padding:10px 13px;display:none;gap:4px;align-items:center;}
.typing-ind.vis{display:flex;}
.td{width:7px;height:7px;background:var(--pu);border-radius:50%;animation:tb 1.2s infinite ease-in-out;}
.td:nth-child(2){animation-delay:.2s;}.td:nth-child(3){animation-delay:.4s;}
@keyframes tb{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-5px);}}
.chat-inp-row{padding:12px;border-top:2px solid var(--bg3);display:flex;gap:7px;flex-shrink:0;background:var(--bg);}
.chat-inp-row input{flex:1;padding:10px 13px;border-radius:var(--rF);border:2px solid var(--bg3);background:var(--sur);font-family:'Outfit',sans-serif;font-size:0.86rem;font-weight:500;color:var(--ink);outline:none;transition:var(--T);}
.chat-inp-row input:focus{border-color:var(--pu);box-shadow:0 0 0 3px rgba(168,85,247,0.12);}
.chat-inp-row input::placeholder{color:var(--ink4);font-weight:400;}
.send-btn{width:40px;height:40px;border-radius:var(--rF);background:var(--g1);border:none;color:white;cursor:pointer;transition:var(--T);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px rgba(255,45,149,0.35);flex-shrink:0;}
.send-btn:hover:not(:disabled){transform:scale(1.1) rotate(45deg);}
.send-btn:disabled{opacity:0.35;cursor:not-allowed;transform:none;}
#activityPanel{display:none;flex:1;overflow-y:auto;padding:10px;flex-direction:column;gap:6px;background:var(--bg);}
#activityPanel.vis{display:flex;}
.ai{display:flex;align-items:flex-start;gap:9px;padding:11px;border-radius:var(--r2);font-size:0.8rem;color:var(--ink);background:var(--sur);border:2px solid var(--bg3);font-weight:500;transition:var(--T);}
.ai:hover{background:var(--bg2);transform:translateX(3px);}
.ai-ico{font-size:1rem;flex-shrink:0;}
.ai strong{font-weight:800;}
.ai-t{font-family:'DM Mono',monospace;font-size:0.62rem;color:var(--ink3);margin-top:2px;}

/* ─────────────────────────────────────────
   TOPBAR
───────────────────────────────────────── */
#main{flex:1;min-height:100vh;display:flex;flex-direction:column;position:relative;z-index:1;}
#topbar{position:sticky;top:0;z-index:200;height:66px;display:flex;align-items:center;justify-content:space-between;gap:14px;padding:0 24px;background:rgba(254,243,255,0.88);backdrop-filter:blur(20px) saturate(180%);border-bottom:1.5px solid var(--bg3);transition:var(--T);}
[data-theme="dark"] #topbar{background:rgba(13,1,24,0.9);}

.menu-btn{width:40px;height:40px;border-radius:var(--r2);border:1.5px solid var(--bg3);background:var(--sur);color:var(--ink3);cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:var(--T);flex-shrink:0;}
.menu-btn:hover{background:var(--g2);border-color:transparent;}
.menu-btn:hover span{background:white;}
.menu-btn span{display:block;width:16px;height:1.5px;background:var(--ink3);border-radius:2px;transition:var(--T);}

.tb-logo{display:flex;align-items:center;gap:9px;flex-shrink:0;cursor:default;}
.tb-logo-name{font-family:'Fraunces',serif;font-size:1.22rem;font-weight:900;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.5px;white-space:nowrap;}

.search-wrap{position:relative;flex:1;max-width:440px;}
.search-wrap svg{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--ink3);pointer-events:none;}
.search-kbd{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-family:'DM Mono',monospace;font-size:0.66rem;background:var(--g2);color:white;border-radius:6px;padding:3px 7px;font-weight:500;}
#searchInput{width:100%;padding:12px 46px 12px 42px;border-radius:var(--rF);border:1.5px solid var(--bg3);background:var(--sur);font-family:'Outfit',sans-serif;font-size:0.9rem;font-weight:500;color:var(--ink);outline:none;transition:var(--T);}
#searchInput:focus{border-color:var(--pu);box-shadow:0 0 0 3px rgba(168,85,247,0.12);}
#searchInput::placeholder{color:var(--ink4);font-weight:400;}

.tb-right{display:flex;align-items:center;gap:9px;}

/* Icon-only topbar buttons — professional SVG icons */
.tb-icon-btn{width:40px;height:40px;border-radius:var(--r2);border:1.5px solid var(--bg3);background:var(--sur);color:var(--ink3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--T);flex-shrink:0;position:relative;}
.tb-icon-btn:hover{background:var(--g2);color:#fff;border-color:transparent;box-shadow:0 4px 14px rgba(168,85,247,0.25);}
.tb-icon-btn svg{width:18px;height:18px;flex-shrink:0;}
.tb-notif-dot{position:absolute;top:5px;right:5px;width:8px;height:8px;border-radius:50%;background:var(--pk);border:2px solid var(--sur);display:none;animation:lpulse 1.5s infinite;}
.tb-notif-dot.vis{display:block;}
@keyframes lpulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.5;transform:scale(0.8);}}

#authBtn{font-family:'Outfit',sans-serif;font-weight:700;font-size:0.86rem;padding:10px 22px;border-radius:var(--rF);border:none;background:var(--g1);color:#fff;cursor:pointer;transition:var(--T);box-shadow:0 4px 14px rgba(255,45,149,0.35);letter-spacing:0.3px;position:relative;overflow:hidden;white-space:nowrap;}
#authBtn::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg,transparent,rgba(255,255,255,0.25),transparent);transform:translateX(-100%);transition:transform 0.6s;}
#authBtn:hover::before{transform:translateX(100%);}
#authBtn:hover{transform:translateY(-1px) scale(1.04);box-shadow:0 8px 22px rgba(255,45,149,0.45);}
#authBtn.li{background:var(--sur);color:var(--pu);border:1.5px solid var(--pu);box-shadow:none;}
#authBtn.li:hover{transform:scale(1.02);box-shadow:0 4px 14px rgba(168,85,247,0.2);}
.authBtn-pulse{animation:btnPulse 3s ease-in-out infinite;}
.authBtn-pulse:hover{animation:none;}
@keyframes btnPulse{0%,100%{box-shadow:0 4px 14px rgba(255,45,149,0.35);}50%{box-shadow:0 4px 28px rgba(255,45,149,0.7),0 0 0 5px rgba(255,45,149,0.12);}}

/* ─────────────────────────────────────────
   CONTENT AREA
───────────────────────────────────────── */
#content{padding:34px 36px;flex:1;display:flex;flex-direction:column;gap:26px;}
.view{display:none;flex-direction:column;gap:24px;}
.view.active{display:flex;}
.ph{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;}
.ph-title{font-family:'Fraunces',serif;font-size:2.6rem;font-weight:900;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-2px;line-height:1;}
.ph-title strong{background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.ph-sub{font-size:0.95rem;color:var(--ink3);margin-top:6px;font-weight:500;}
.ph-chip{background:var(--g3);color:white;border-radius:var(--rF);padding:7px 18px;font-family:'DM Mono',monospace;font-size:0.76rem;font-weight:500;box-shadow:var(--sh2);white-space:nowrap;letter-spacing:0.5px;}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
.stat-card{background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r3);padding:24px;position:relative;overflow:hidden;box-shadow:var(--sh2);transition:var(--T);}
.stat-card:hover{box-shadow:var(--sh3);transform:translateY(-3px);border-color:transparent;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;}
.stat-card:nth-child(1)::before{background:var(--g1);}
.stat-card:nth-child(2)::before{background:var(--g3);}
.stat-card:nth-child(3)::before{background:var(--g4);}
.stat-icon{width:48px;height:48px;border-radius:var(--r2);display:flex;align-items:center;justify-content:center;margin-bottom:16px;font-size:1.5rem;}
.stat-n{font-family:'Fraunces',serif;font-size:2.8rem;line-height:1;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-3px;font-weight:900;}
.stat-l{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);margin-top:6px;}

/* Section cards */
.sc{background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r4);overflow:hidden;box-shadow:var(--sh2);}
.sc-head{padding:20px 26px;border-bottom:2px solid var(--bg3);display:flex;align-items:center;justify-content:space-between;gap:14px;background:var(--bg);}
.sc-title{font-size:1.05rem;font-weight:800;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-0.3px;}
.sc-body{padding:24px;}

/* Events grid */
.ev-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;}
.ev-card{background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r3);overflow:hidden;transition:var(--T);box-shadow:var(--sh1);cursor:pointer;position:relative;display:flex;flex-direction:column;}
.ev-card:hover{transform:translateY(-6px) scale(1.015);box-shadow:var(--sh3);border-color:transparent;}
.ev-card-bar{height:7px;background:var(--cat-c,var(--g1));position:relative;overflow:hidden;}
.ev-card-bar::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.45),transparent);animation:shim 2s infinite;}
@keyframes shim{to{transform:translateX(100%);}}

/* Event image area */
.ev-img{width:100%;height:140px;object-fit:cover;display:block;}
.ev-img-placeholder{width:100%;height:140px;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-size:2.5rem;position:relative;overflow:hidden;}
.ev-img-placeholder::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--cat-c,rgba(168,85,247,0.2)),transparent);}

.ev-body{padding:18px;flex:1;display:flex;flex-direction:column;gap:9px;}
.ev-badge{display:inline-flex;align-items:center;gap:5px;font-size:0.66rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;padding:4px 10px;border-radius:var(--rF);width:fit-content;color:white;background:var(--cat-c,var(--g1));}
.ev-badge-dot{width:5px;height:5px;border-radius:50%;background:white;}
.ev-privacy{font-size:0.62rem;font-weight:700;padding:3px 8px;border-radius:var(--rF);margin-left:4px;}
.ev-privacy.pub{background:rgba(16,185,129,0.15);color:var(--gr);}
.ev-privacy.prv{background:rgba(168,85,247,0.15);color:var(--pu);}
.ev-title{font-size:1.05rem;font-weight:800;color:var(--ink);line-height:1.3;letter-spacing:-0.2px;}
.ev-meta{font-size:0.78rem;color:var(--ink3);display:flex;align-items:center;gap:5px;font-weight:500;}
.ev-desc{font-size:0.8rem;color:var(--ink3);line-height:1.55;font-weight:400;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.ev-tags{display:flex;gap:5px;flex-wrap:wrap;}
.ev-tag{font-size:0.66rem;font-weight:700;padding:3px 9px;border-radius:var(--rF);background:var(--bg2);color:var(--ink3);border:1px solid var(--bg3);}
.ev-footer{padding:14px 18px;border-top:2px solid var(--bg3);display:flex;align-items:center;justify-content:space-between;gap:8px;background:var(--bg);}
.host-row{display:flex;align-items:center;gap:8px;}
.h-av{width:28px;height:28px;border-radius:50%;object-fit:cover;border:2px solid var(--bg3);flex-shrink:0;}
.h-name{font-size:0.78rem;font-weight:700;color:var(--ink);}
.ev-actions{display:flex;align-items:center;gap:7px;}
.rsvp-count{font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--ink3);display:flex;align-items:center;gap:4px;}
.btn-rsvp{font-family:'Outfit',sans-serif;font-size:0.74rem;font-weight:700;padding:6px 13px;border-radius:var(--rF);border:1.5px solid var(--bg3);background:var(--sur);color:var(--ink3);cursor:pointer;transition:var(--T);}
.btn-rsvp:hover{border-color:var(--gr);color:var(--gr);background:rgba(16,185,129,0.08);}
.btn-rsvp.going{background:var(--g3);border-color:transparent;color:white;}

/* Buttons */
.btn{font-family:'Outfit',sans-serif;font-weight:700;font-size:0.9rem;padding:12px 26px;border-radius:var(--rF);border:none;cursor:pointer;transition:var(--T);display:inline-flex;align-items:center;gap:8px;white-space:nowrap;letter-spacing:0.3px;}
.btn-p{background:var(--g1);color:#fff;box-shadow:0 4px 14px rgba(255,45,149,0.35);}
.btn-p:hover:not(:disabled){transform:translateY(-1px) scale(1.04);box-shadow:0 8px 22px rgba(255,45,149,0.45);}
.btn-p:disabled{opacity:0.45;cursor:not-allowed;transform:none;}
.btn-g{background:transparent;border:1.5px solid var(--bg3);color:var(--ink);}
.btn-g:hover{border-color:var(--pu);color:var(--pu);background:rgba(168,85,247,0.07);}
.btn-o{background:var(--g2);color:#fff;}
.btn-o:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 8px 22px rgba(168,85,247,0.4);}
.btn-sm{font-size:0.76rem;padding:9px 16px;}

/* Form fields */
.field{display:flex;flex-direction:column;gap:7px;}
.field label{font-size:0.68rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);}
.field input,.field select,.field textarea{padding:12px 14px;border-radius:var(--r2);border:1.5px solid var(--bg3);background:var(--sur);font-family:'Outfit',sans-serif;font-size:0.9rem;font-weight:500;color:var(--ink);outline:none;transition:var(--T);}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--pu);box-shadow:0 0 0 3px rgba(168,85,247,0.12);}
.field input::placeholder,.field textarea::placeholder{color:var(--ink4);font-weight:400;}
.field textarea{resize:vertical;min-height:90px;line-height:1.6;}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:16px;margin-bottom:20px;}

/* Map */
#map{height:480px;border-radius:0 0 var(--r4) var(--r4);}

/* Users */
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;}
.user-card{background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r3);padding:24px 20px 20px;display:flex;flex-direction:column;align-items:center;gap:11px;text-align:center;transition:var(--T);box-shadow:var(--sh1);position:relative;overflow:hidden;}
.user-card:hover{box-shadow:var(--sh3);transform:translateY(-5px);border-color:transparent;}
.user-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gR);opacity:0;transition:var(--T);}
.user-card:hover::before{opacity:1;}
.uav-wrap{position:relative;}
.uav-wrap img{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid var(--bg3);transition:var(--T);}
.user-card:hover .uav-wrap img{border-color:transparent;box-shadow:0 0 20px rgba(168,85,247,0.45);transform:scale(1.08);}
.u-odot{width:14px;height:14px;background:var(--gr);border-radius:50%;border:3px solid var(--sur);position:absolute;bottom:3px;right:3px;box-shadow:0 0 10px var(--gr);animation:lpulse 1.5s infinite;}
.uname{font-size:1rem;font-weight:800;color:var(--ink);}
.umeta{font-size:0.75rem;color:var(--ink3);font-weight:500;}

/* ── Create Event Form ── */
.create-hero{background:linear-gradient(135deg,#1a0b2e,#0f0520);border-radius:var(--r4);padding:36px;position:relative;overflow:hidden;margin-bottom:4px;}
.create-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 80% at 30% 50%,rgba(255,45,149,0.25),transparent 70%),radial-gradient(ellipse 50% 60% at 80% 30%,rgba(168,85,247,0.2),transparent 70%);pointer-events:none;}
.create-hero-inner{position:relative;z-index:2;}
.create-hero h2{font-family:'Fraunces',serif;font-size:2.2rem;font-weight:900;color:#fff;letter-spacing:-1px;margin-bottom:8px;}
.create-hero p{color:rgba(255,255,255,0.65);font-size:0.95rem;font-weight:400;line-height:1.65;}

.create-form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
@media(max-width:720px){.create-form-grid{grid-template-columns:1fr;}}
.field-full{grid-column:1/-1;}

/* Image upload area */
.img-upload{border:2px dashed var(--bg3);border-radius:var(--r3);padding:32px;text-align:center;cursor:pointer;transition:var(--T);position:relative;overflow:hidden;}
.img-upload:hover{border-color:var(--pk);background:rgba(255,45,149,0.04);}
.img-upload input{position:absolute;inset:0;opacity:0;cursor:pointer;}
.img-upload-icon{font-size:2.2rem;margin-bottom:10px;display:block;}
.img-upload-txt{font-size:0.86rem;font-weight:600;color:var(--ink3);}
.img-upload-sub{font-size:0.74rem;color:var(--ink4);margin-top:4px;}
.img-preview{width:100%;max-height:200px;object-fit:cover;border-radius:var(--r2);display:none;}

/* Privacy toggle */
.privacy-toggle{display:flex;gap:10px;}
.priv-opt{flex:1;padding:12px;border-radius:var(--r2);border:2px solid var(--bg3);background:var(--sur);cursor:pointer;transition:var(--T);text-align:center;font-size:0.82rem;font-weight:700;color:var(--ink3);}
.priv-opt:hover{border-color:var(--pu);}
.priv-opt.sel{border-color:var(--pk);background:rgba(255,45,149,0.07);color:var(--pk);}
.priv-opt .pi{font-size:1.3rem;display:block;margin-bottom:4px;}

/* Tags input */
.tags-input-wrap{display:flex;flex-wrap:wrap;gap:6px;padding:10px 12px;border:1.5px solid var(--bg3);border-radius:var(--r2);background:var(--sur);min-height:48px;align-items:center;cursor:text;transition:var(--T);}
.tags-input-wrap:focus-within{border-color:var(--pu);box-shadow:0 0 0 3px rgba(168,85,247,0.12);}
.tag-chip{display:inline-flex;align-items:center;gap:5px;background:var(--g2);color:white;font-size:0.72rem;font-weight:700;padding:3px 10px;border-radius:var(--rF);}
.tag-chip-x{background:none;border:none;color:white;cursor:pointer;font-size:0.85rem;padding:0;line-height:1;opacity:0.7;}
.tag-chip-x:hover{opacity:1;}
.tag-raw-input{border:none;outline:none;background:none;font-family:'Outfit',sans-serif;font-size:0.86rem;color:var(--ink);flex:1;min-width:80px;font-weight:500;}
.tag-raw-input::placeholder{color:var(--ink4);}

/* ── User Profile Panel ── */
#view-profile-view .profile-panel{display:grid;grid-template-columns:300px 1fr;gap:24px;align-items:start;}
@media(max-width:900px){#view-profile-view .profile-panel{grid-template-columns:1fr;}}
.profile-sidebar-card{background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r4);overflow:hidden;box-shadow:var(--sh2);}
.profile-cover{height:120px;background:var(--g2);position:relative;}
.profile-cover-inner{position:absolute;inset:0;display:flex;align-items:flex-end;padding:16px;}
.profile-av-wrap{position:relative;margin-top:-36px;margin-left:20px;}
.profile-av{width:80px;height:80px;border-radius:50%;object-fit:cover;border:4px solid var(--sur);box-shadow:0 0 20px rgba(168,85,247,0.4);}
.profile-av-edit{position:absolute;bottom:0;right:0;width:28px;height:28px;border-radius:50%;background:var(--g1);border:2px solid var(--sur);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:var(--T);font-size:0.75rem;}
.profile-av-edit:hover{transform:scale(1.1);}
.profile-info{padding:16px 20px 20px;}
.profile-name-edit{font-size:1.2rem;font-weight:900;color:var(--ink);letter-spacing:-0.3px;margin-bottom:4px;}
.profile-handle{font-size:0.8rem;color:var(--ink3);font-weight:500;margin-bottom:14px;}
.profile-bio{font-size:0.84rem;color:var(--ink3);line-height:1.65;margin-bottom:16px;}
.profile-stats-row{display:flex;gap:16px;padding:14px 20px;border-top:2px solid var(--bg3);background:var(--bg);}
.p-stat{text-align:center;flex:1;}
.p-stat-n{font-family:'Fraunces',serif;font-size:1.6rem;font-weight:900;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;letter-spacing:-1px;}
.p-stat-l{font-size:0.62rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);margin-top:3px;}

.profile-main-card{background:var(--sur);border:2px solid var(--bg3);border-radius:var(--r4);overflow:hidden;box-shadow:var(--sh2);}
.profile-tabs{display:flex;border-bottom:2px solid var(--bg3);background:var(--bg);padding:0 20px;}
.p-tab{padding:14px 16px;font-size:0.76rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink4);cursor:pointer;border-bottom:3px solid transparent;margin-bottom:-2px;transition:var(--T);background:none;border-top:none;border-left:none;border-right:none;font-family:'Outfit',sans-serif;}
.p-tab:hover{color:var(--ink2);}
.p-tab.active{color:var(--pu);border-bottom-color:var(--pu);}
.p-tab-body{padding:22px;display:none;}
.p-tab-body.active{display:block;}

/* Customizer */
.customizer-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
.cust-section{background:var(--bg);border:2px solid var(--bg3);border-radius:var(--r3);padding:18px;}
.cust-section h4{font-size:0.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);margin-bottom:14px;}
.av-grid{display:flex;flex-wrap:wrap;gap:8px;}
.av-opt{width:48px;height:48px;border-radius:50%;border:3px solid var(--bg3);cursor:pointer;transition:var(--T);overflow:hidden;flex-shrink:0;}
.av-opt img{width:100%;height:100%;object-fit:cover;}
.av-opt:hover{border-color:var(--pu);transform:scale(1.08);}
.av-opt.sel{border-color:var(--pk);box-shadow:0 0 0 3px rgba(255,45,149,0.25);}
.color-grid{display:flex;flex-wrap:wrap;gap:8px;}
.color-opt{width:28px;height:28px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:var(--T);}
.color-opt:hover,.color-opt.sel{border-color:#fff;transform:scale(1.3);box-shadow:0 0 12px currentColor;}
.badge-display{display:flex;flex-wrap:wrap;gap:8px;}
.badge{display:inline-flex;align-items:center;gap:5px;font-size:0.7rem;font-weight:700;padding:5px 11px;border-radius:var(--rF);background:var(--bg2);color:var(--ink3);border:1.5px solid var(--bg3);}
.badge.earned{background:var(--g2);color:#fff;border-color:transparent;}

/* ── My Events list ── */
.my-events-list{display:flex;flex-direction:column;gap:12px;}
.my-ev-row{display:flex;align-items:center;gap:14px;padding:14px;border-radius:var(--r3);border:2px solid var(--bg3);background:var(--sur);transition:var(--T);}
.my-ev-row:hover{border-color:var(--pu);box-shadow:var(--sh2);}
.my-ev-color{width:5px;border-radius:var(--rF);align-self:stretch;flex-shrink:0;}
.my-ev-info{flex:1;min-width:0;}
.my-ev-name{font-size:0.9rem;font-weight:800;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.my-ev-sub{font-size:0.74rem;color:var(--ink3);margin-top:2px;font-weight:500;}
.my-ev-actions{display:flex;gap:6px;flex-shrink:0;}
.icon-btn{width:32px;height:32px;border-radius:var(--r1);border:1.5px solid var(--bg3);background:var(--sur);color:var(--ink3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--T);font-size:0.8rem;}
.icon-btn:hover{background:var(--g1);color:#fff;border-color:transparent;}
.icon-btn.del:hover{background:linear-gradient(135deg,#ef4444,#dc2626);}

/* ─────────────────────────────────────────
   AUTH MODAL
───────────────────────────────────────── */
.ov{display:none;position:fixed;inset:0;background:rgba(10,0,20,0.88);backdrop-filter:blur(18px) saturate(180%);z-index:1000;align-items:center;justify-content:center;}
.ov.open{display:flex;}
.mo{background:var(--sur);border:2px solid var(--pu);border-radius:var(--r4);padding:40px;width:100%;max-width:490px;box-shadow:0 20px 80px rgba(168,85,247,0.5);animation:moIn .38s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;max-height:92vh;overflow-y:auto;}
.mo::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gR);animation:rbSlide 8s linear infinite;background-size:200% 100%;}
@keyframes moIn{from{opacity:0;transform:scale(.9) translateY(28px);}to{opacity:1;transform:scale(1) translateY(0);}}
.mo-eyebrow{font-size:0.66rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;}
.mo h2{font-family:'Fraunces',serif;font-size:2.2rem;font-weight:900;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;letter-spacing:-1px;line-height:1.1;}
.mo p{color:var(--ink3);font-size:0.9rem;margin-bottom:24px;line-height:1.7;}
.auth-tabs{display:flex;background:var(--bg2);border-radius:var(--r2);padding:3px;margin-top:6px;}
.auth-tab{flex:1;padding:9px;border:none;border-radius:var(--r1);font-family:'Outfit',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;transition:var(--T);background:transparent;color:var(--ink3);}
.auth-tab.active{background:var(--g1);color:#fff;box-shadow:0 4px 12px rgba(255,45,149,0.3);}
.av-picker-label{font-size:0.68rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);margin-bottom:9px;margin-top:2px;}
.av-picker{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.av-option{width:48px;height:48px;border-radius:50%;border:3px solid var(--bg3);cursor:pointer;transition:var(--T);overflow:hidden;background:var(--bg2);flex-shrink:0;}
.av-option img{width:100%;height:100%;object-fit:cover;}
.av-option:hover{border-color:var(--pu);transform:scale(1.08);}
.av-option.selected{border-color:var(--pk);box-shadow:0 0 0 3px rgba(255,45,149,0.25);transform:scale(1.1);}
.pw-wrap{position:relative;display:flex;align-items:center;}
.pw-wrap input{flex:1;padding-right:44px!important;}
.pw-eye{position:absolute;right:13px;background:none;border:none;cursor:pointer;font-size:0.95rem;opacity:0.45;transition:var(--T);padding:0;line-height:1;}
.pw-eye:hover{opacity:1;transform:scale(1.2);}
.pw-strength{height:3px;border-radius:999px;background:var(--bg3);overflow:hidden;margin-top:5px;}
.pw-sf{height:100%;border-radius:999px;transition:width 0.4s ease,background 0.4s ease;}
.auth-switch{text-align:center;margin-top:12px;font-size:0.8rem;color:var(--ink3);}
.auth-switch span{color:var(--pk);cursor:pointer;font-weight:700;}
.auth-switch span:hover{text-decoration:underline;}
.mo-actions{display:flex;gap:10px;margin-top:20px;}
@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-5px);}40%,80%{transform:translateX(5px);}}
.shake{animation:shake 0.38s ease;}

/* ─────────────────────────────────────────
   FOOTER
───────────────────────────────────────── */
#masthead{background:linear-gradient(180deg,#1a0b2e,#0f0520);position:relative;overflow:hidden;margin-top:auto;}
#masthead::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 50% at 20% 40%,rgba(255,45,149,0.28),transparent 70%),radial-gradient(ellipse 50% 60% at 80% 60%,rgba(168,85,247,0.22),transparent 70%);pointer-events:none;}
.mh-stripe{height:3px;background:var(--gR);animation:rbSlide 8s linear infinite;background-size:200% 100%;}
.mh-inner{max-width:1200px;margin:0 auto;padding:52px 36px 0;position:relative;z-index:2;}
.mh-hero{display:flex;align-items:center;justify-content:space-between;gap:36px;padding-bottom:44px;border-bottom:1px solid rgba(255,255,255,0.08);}
.mh-logo-area{display:flex;flex-direction:column;gap:18px;}
.mh-logo-row{display:flex;align-items:center;gap:14px;}
.mh-logo-name{font-family:'Fraunces',serif;font-size:3.2rem;font-weight:900;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-2px;line-height:1;}
.mh-tagline{font-size:0.98rem;font-weight:400;color:rgba(255,255,255,0.55);max-width:400px;line-height:1.75;}
.mh-links{display:grid;grid-template-columns:repeat(3,150px);gap:36px;}
.mh-lg h4{font-size:0.66rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,0.35);margin-bottom:14px;}
.mh-lg a{display:block;font-size:0.9rem;font-weight:500;color:rgba(255,255,255,0.6);text-decoration:none;margin-bottom:11px;transition:var(--T);}
.mh-lg a:hover{color:var(--pk);transform:translateX(5px);}
.mh-bottom{padding:24px 0;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
.mh-copy{font-size:0.8rem;font-weight:500;color:rgba(255,255,255,0.3);}
.mh-copy span{color:rgba(255,255,255,0.5);}
.mh-builder{display:flex;align-items:center;gap:12px;background:rgba(255,45,149,0.12);border:1.5px solid rgba(255,45,149,0.28);border-radius:var(--rF);padding:7px 18px 7px 7px;transition:var(--T);}
.mh-builder:hover{background:rgba(255,45,149,0.22);transform:translateY(-2px);box-shadow:0 8px 22px rgba(255,45,149,0.35);}
.mh-builder-av{width:34px;height:34px;border-radius:50%;background:var(--g1);display:flex;align-items:center;justify-content:center;font-size:0.82rem;font-weight:900;color:#fff;box-shadow:0 0 14px rgba(255,45,149,0.5);}
.mh-builder-text{display:flex;flex-direction:column;}
.mh-builder-built{font-size:0.6rem;color:rgba(255,255,255,0.38);font-weight:600;letter-spacing:0.5px;}
.mh-builder-name{font-size:0.86rem;font-weight:800;color:#fff;}
.mh-social{display:flex;gap:9px;}
.mh-soc-btn{width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.08);border:1.5px solid rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-size:0.9rem;color:rgba(255,255,255,0.55);cursor:pointer;transition:var(--T);}
.mh-soc-btn:hover{background:var(--g1);color:#fff;transform:translateY(-3px) scale(1.1);border-color:transparent;}
.mh-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:20px;}
.mh-pill{font-size:0.7rem;font-weight:700;padding:5px 13px;border-radius:var(--rF);border:1.5px solid rgba(255,255,255,0.12);color:rgba(255,255,255,0.45);background:rgba(255,255,255,0.04);transition:var(--T);cursor:default;}
.mh-pill:hover{border-color:var(--pk);color:var(--pk);background:rgba(255,45,149,0.12);}

/* Misc */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(70px);z-index:9999;background:var(--g2);color:#fff;padding:12px 24px;border-radius:var(--rF);font-size:0.88rem;font-weight:700;box-shadow:0 8px 28px rgba(168,85,247,0.45);opacity:0;transition:var(--T);border:1.5px solid rgba(255,255,255,0.18);white-space:nowrap;}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
.es{text-align:center;padding:48px 16px;color:var(--ink3);font-size:0.9rem;font-weight:500;grid-column:1/-1;}
.es .ei{font-size:2.8rem;display:block;margin-bottom:12px;opacity:0.3;}
.es p{margin-top:5px;font-size:0.78rem;color:var(--ink4);}
.sp{width:16px;height:16px;border:2.5px solid rgba(255,255,255,0.3);border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes slideUp{from{opacity:0;transform:translateY(18px);}to{opacity:1;transform:translateY(0);}}
.su{animation:slideUp 0.5s ease both;} .su1{animation:slideUp 0.5s 0.1s ease both;} .su2{animation:slideUp 0.5s 0.2s ease both;} .su3{animation:slideUp 0.5s 0.3s ease both;}
::-webkit-scrollbar{width:5px;} ::-webkit-scrollbar-thumb{background:var(--g1);border-radius:8px;} ::-webkit-scrollbar-track{background:transparent;}

/* Geo status */
#geoStatus{font-size:0.8rem;color:var(--ink3);font-weight:600;display:flex;align-items:center;gap:5px;}


/* ── Config Modal ── */
#configModal{display:none;position:fixed;inset:0;background:rgba(10,0,20,0.95);backdrop-filter:blur(20px);z-index:2000;align-items:center;justify-content:center;}
#configModal.open{display:flex;}
.cfg-box{background:var(--sur);border:2px solid var(--pu);border-radius:var(--r4);padding:36px;width:100%;max-width:520px;box-shadow:0 20px 80px rgba(168,85,247,0.5);animation:moIn .38s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;}
.cfg-box::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--gR);animation:rbSlide 8s linear infinite;background-size:200% 100%;}
.cfg-eyebrow{font-size:0.66rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;background:var(--g1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;}
.cfg-box h2{font-family:'Fraunces',serif;font-size:2rem;font-weight:900;background:var(--g2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;letter-spacing:-1px;}
.cfg-box p{color:var(--ink3);font-size:0.88rem;margin-bottom:22px;line-height:1.7;}
.cfg-fields{display:flex;flex-direction:column;gap:14px;margin-bottom:22px;}
.cfg-field{display:flex;flex-direction:column;gap:6px;}
.cfg-field label{font-size:0.68rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--ink3);}
.cfg-field input{padding:12px 14px;border-radius:var(--r2);border:1.5px solid var(--bg3);background:var(--bg);font-family:'DM Mono',monospace;font-size:0.82rem;color:var(--ink);outline:none;transition:var(--T);}
.cfg-field input:focus{border-color:var(--pu);box-shadow:0 0 0 3px rgba(168,85,247,0.12);}
.cfg-field input::placeholder{color:var(--ink4);font-weight:400;}
.cfg-hint{font-size:0.72rem;color:var(--ink4);margin-top:3px;line-height:1.5;}
.cfg-hint a{color:var(--cy);text-decoration:none;font-weight:600;}
.cfg-hint a:hover{text-decoration:underline;}
.cfg-status{font-size:0.8rem;font-weight:600;padding:10px 14px;border-radius:var(--r2);margin-bottom:14px;display:none;}
.cfg-status.ok{background:rgba(16,185,129,0.12);color:var(--gr);border:1.5px solid rgba(16,185,129,0.3);}
.cfg-status.err{background:rgba(239,68,68,0.1);color:#ef4444;border:1.5px solid rgba(239,68,68,0.25);}

/* ── Responsive ── */
@media(max-width:768px){
  #content{padding:18px;}
  #topbar{padding:0 14px;}
  .stats-grid{grid-template-columns:1fr 1fr;}
  .mh-inner{padding:36px 18px 0;}
  .mh-hero{flex-direction:column;gap:26px;}
  .mh-links{grid-template-columns:repeat(2,1fr);}
  .ph-title{font-size:2rem;}
  #chat-popout{width:100%;}
  .search-kbd{display:none;}
}
</style>
</head>
<body>

<!-- Sidebar overlay -->
<div id="sb-overlay"></div>

<!-- ══════════════ SIDEBAR ══════════════ -->
<aside id="sidebar">
  <div class="sb-head">
    <div class="logo-row">
      <svg width="34" height="34" viewBox="0 0 110 110" fill="none"><ellipse cx="40" cy="28" rx="15" ry="24" transform="rotate(-35 40 28)" fill="#ff2d95" opacity=".95"/><ellipse cx="68" cy="22" rx="15" ry="24" transform="rotate(25 68 22)" fill="#f97316" opacity=".95"/><ellipse cx="20" cy="58" rx="15" ry="24" transform="rotate(-65 20 58)" fill="#fbbf24" opacity=".92"/><ellipse cx="36" cy="80" rx="15" ry="24" transform="rotate(-15 36 80)" fill="#10b981" opacity=".92"/><ellipse cx="64" cy="86" rx="15" ry="24" transform="rotate(20 64 86)" fill="#06b6d4" opacity=".92"/><ellipse cx="90" cy="58" rx="15" ry="24" transform="rotate(65 90 58)" fill="#3b82f6" opacity=".92"/><ellipse cx="76" cy="32" rx="14" ry="22" transform="rotate(10 76 32)" fill="#a855f7" opacity=".88"/><ellipse cx="52" cy="50" rx="12" ry="18" fill="rgba(230,180,255,0.7)" opacity=".8"/></svg>
      <div class="logo-word">Krowdly</div>
    </div>
    <button class="sb-x" id="sidebarClose">✕</button>
  </div>

  <nav class="sb-nav">
    <div class="sb-label">Explore</div>
    <button class="ni active" data-view="discover">
      <svg class="ni-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Discover
    </button>
    <button class="ni" data-view="create-view">
      <svg class="ni-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      Host Events
    </button>
    <button class="ni" data-view="map-view">
      <svg class="ni-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
      Live Map
    </button>
    <button class="ni" data-view="users-view">
      <svg class="ni-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      Squad
    </button>
    <button class="ni" id="chatNavBtn">
      <svg class="ni-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Chat
      <span class="ni-badge" id="sidebarChatBadge"></span>
    </button>

    <!-- Profile link (logged-in only) -->
    <div id="profileNavWrap" style="display:none;">
      <div class="sb-label">Account</div>
      <button class="ni" data-view="profile-view">
        <svg class="ni-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        My Profile
      </button>
    </div>

    <div class="sb-label">Vibes</div>
    <div class="cat-strip" id="catList"></div>
    <button class="cat-add" id="catAddBtn">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Vibe
    </button>
    <div class="cnf" id="cnf">
      <input id="catNameInput" placeholder="Name your vibe…" maxlength="30">
      <div class="sw-row" id="swRow"></div>
      <div class="cnf-acts">
        <button class="btn btn-p btn-sm" id="catSaveBtn" style="flex:1;">Create</button>
        <button class="btn btn-g btn-sm" id="catCancelBtn">Cancel</button>
      </div>
    </div>
  </nav>

  <div class="sb-foot">
    <!-- Guest state -->
    <div id="sbGuest" class="sb-guest-row">
      <span class="sb-guest-txt">Not signed in</span>
      <button class="theme-btn" id="themeToggleGuest" title="Toggle theme">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
    </div>
    <!-- Logged-in profile card -->
    <div id="sbLoggedIn" style="display:none;">
      <div class="profile-card">
        <div class="pc-top">
          <img class="pc-av" id="profileAvatar" src="" alt="">
          <div class="pc-info">
            <div class="pc-name" id="profileName"></div>
            <div class="pc-tag">
              <span id="onlineDot" style="width:7px;height:7px;border-radius:50%;background:var(--gr);display:inline-block;box-shadow:0 0 8px var(--gr);"></span>
              Krowdie
            </div>
          </div>
          <button class="theme-btn" id="themeToggle" title="Toggle theme">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          </button>
        </div>
        <div class="pc-actions">
          <button class="pc-btn" onclick="navTo('profile-view')">My Profile</button>
          <button class="pc-btn" onclick="navTo('create-view')">Host Event</button>
          <button class="pc-btn danger" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>
  </div>
</aside>

<!-- ══════════════ CHAT POPOUT ══════════════ -->
<div id="chat-popout">
  <div class="cp-head">
    <div class="cp-toprow">
      <span class="cp-title">Messages</span>
      <button class="cp-x" id="chatClose">✕</button>
    </div>
    <div class="cp-tabs">
      <button class="cp-tab active" id="cpTabMsg" onclick="switchChatTab('messages')">Messages</button>
      <button class="cp-tab" id="cpTabAct" onclick="switchChatTab('activity')">Activity</button>
    </div>
  </div>
  <div id="cpMsgPanel" style="display:flex;flex-direction:column;flex:1;overflow:hidden;">
    <div id="chatUserList"></div>
    <div class="chat-top">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span id="chatRLabel">Pick someone to chat with</span>
    </div>
    <div id="chatBox"><div class="es" style="padding:20px 10px;"><span class="ei">💬</span>Choose someone above</div></div>
    <div class="typing-ind" id="ti"><div class="td"></div><div class="td"></div><div class="td"></div></div>
    <div class="chat-inp-row">
      <input id="chatInput" placeholder="Type a message…" maxlength="500" disabled>
      <button class="send-btn" id="sendMsgBtn" disabled>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
  </div>
  <div id="activityPanel">
    <div class="es" id="actEmpty" style="padding:18px 10px;"><span class="ei">📡</span>Live activity here</div>
  </div>
</div>

<!-- ══════════════ MAIN ══════════════ -->
<div id="main">
  <header id="topbar">
    <button class="menu-btn" id="menuBtn" title="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="tb-logo">
      <svg width="28" height="28" viewBox="0 0 110 110" fill="none"><ellipse cx="40" cy="28" rx="15" ry="24" transform="rotate(-35 40 28)" fill="#ff2d95" opacity=".95"/><ellipse cx="68" cy="22" rx="15" ry="24" transform="rotate(25 68 22)" fill="#f97316" opacity=".95"/><ellipse cx="20" cy="58" rx="15" ry="24" transform="rotate(-65 20 58)" fill="#fbbf24" opacity=".92"/><ellipse cx="36" cy="80" rx="15" ry="24" transform="rotate(-15 36 80)" fill="#10b981" opacity=".92"/><ellipse cx="64" cy="86" rx="15" ry="24" transform="rotate(20 64 86)" fill="#06b6d4" opacity=".92"/><ellipse cx="90" cy="58" rx="15" ry="24" transform="rotate(65 90 58)" fill="#3b82f6" opacity=".92"/><ellipse cx="76" cy="32" rx="14" ry="22" transform="rotate(10 76 32)" fill="#a855f7" opacity=".88"/><ellipse cx="52" cy="50" rx="12" ry="18" fill="rgba(230,180,255,0.7)" opacity=".8"/></svg>
      <span class="tb-logo-name">Krowdly</span>
    </div>
    <div class="search-wrap">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="searchInput" placeholder="Search events, people…" autocomplete="off">
      <span class="search-kbd">⌘K</span>
    </div>
    <div class="tb-right">
      <!-- Chat button — speech bubble icon -->
      <button class="tb-icon-btn" id="topbarChatBtn" title="Messages">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span class="tb-notif-dot" id="chatNotifDot"></span>
      </button>
      <!-- Theme toggle — sun/moon icon -->
      <button class="tb-icon-btn" id="topbarThemeBtn" title="Toggle theme">
        <svg id="themeIconSun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg id="themeIconMoon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
      <!-- Settings/config button — always visible so you can re-enter backend URL -->
      <button class="tb-icon-btn" id="configBtn" title="Configure backend">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
      <button id="authBtn" class="authBtn-pulse">Sign Up</button>
    </div>
  </header>

  <div id="content">

    <!-- ── DISCOVER ── -->
    <div class="view active" id="view-discover">
      <div class="ph su">
        <div>
          <div class="ph-title">What's <strong>Happening</strong></div>
          <div class="ph-sub">Events near you, right now ✨</div>
        </div>
      </div>
      <div class="stats-grid su1">
        <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,rgba(255,45,149,0.15),rgba(247,147,20,0.15));">🎉</div><div class="stat-n" id="statTotal">—</div><div class="stat-l">Total Events</div></div>
        <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,rgba(6,182,212,0.15),rgba(16,185,129,0.15));">✓</div><div class="stat-n" id="statAttending">0</div><div class="stat-l">You're Going</div></div>
        <div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,rgba(168,85,247,0.15),rgba(59,130,246,0.15));">👥</div><div class="stat-n" id="statMembers">—</div><div class="stat-l">Members</div></div>
      </div>
      <div class="sc su2">
        <div class="sc-head">
          <span class="sc-title">All Events</span>
          <div style="display:flex;gap:8px;align-items:center;">
            <span id="filteredChip" style="display:none;" class="ph-chip"></span>
          </div>
        </div>
        <div class="sc-body"><div class="ev-grid" id="eventGrid"><div class="es"><span class="ei">✨</span>Loading events…<p>Your city's events will appear here</p></div></div></div>
      </div>
    </div>

    <!-- ── HOST EVENT (create) ── -->
    <div class="view" id="view-create-view">
      <div class="create-hero su">
        <div class="create-hero-inner">
          <h2>Host an Event</h2>
          <p>Bring your people together. Fill in the details below and your event goes live instantly.</p>
        </div>
      </div>

      <div class="sc su1">
        <div class="sc-head"><span class="sc-title">Event Details</span></div>
        <div class="sc-body">

          <!-- Image upload -->
          <div class="field" style="margin-bottom:20px;">
            <label>Cover Image</label>
            <div class="img-upload" id="imgUploadArea">
              <input type="file" id="imgFileInput" accept="image/*">
              <img class="img-preview" id="imgPreview" alt="Preview">
              <div id="imgUploadPrompt">
                <span class="img-upload-icon">🖼️</span>
                <div class="img-upload-txt">Click or drag to upload a cover image</div>
                <div class="img-upload-sub">JPG, PNG, GIF up to 5MB</div>
              </div>
            </div>
          </div>

          <div class="create-form-grid">
            <div class="field field-full"><label>Event Title *</label><input id="evTitle" placeholder="e.g. Lagos Rooftop Hangout" maxlength="80"></div>
            <div class="field field-full"><label>Description</label><textarea id="evDesc" placeholder="Tell people what this event is about, what to expect, what to bring…" maxlength="500"></textarea></div>
            <div class="field"><label>Location / Venue *</label><input id="evLocation" placeholder="e.g. Victoria Island, Lagos" maxlength="120"></div>
            <div class="field"><label>Date *</label><input id="evDate" type="date"></div>
            <div class="field"><label>Start Time</label><input id="evTime" type="time"></div>
            <div class="field"><label>Vibe / Category *</label><select id="evCategory"></select></div>
            <div class="field"><label>Max Attendees</label><input id="evMax" type="number" placeholder="Leave blank for unlimited" min="1"></div>
            <div class="field field-full">
              <label>Tags <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.72rem;color:var(--ink4);">(press Enter or comma)</span></label>
              <div class="tags-input-wrap" id="tagsWrap">
                <input class="tag-raw-input" id="tagInput" placeholder="music, free, outdoor…">
              </div>
            </div>
            <div class="field field-full">
              <label>Visibility</label>
              <div class="privacy-toggle" id="privacyToggle">
                <div class="priv-opt sel" data-val="public"><span class="pi">🌍</span>Public<br><small style="font-weight:400;font-size:0.66rem;opacity:0.7;">Everyone can see it</small></div>
                <div class="priv-opt" data-val="private"><span class="pi">🔒</span>Private<br><small style="font-weight:400;font-size:0.66rem;opacity:0.7;">Invite only</small></div>
              </div>
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-top:8px;">
            <button class="btn btn-p" id="postBtn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              Publish Event
            </button>
            <div id="geoStatus"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ── LIVE MAP ── -->
    <div class="view" id="view-map-view">
      <div class="ph su"><div><div class="ph-title">Live <strong>Map</strong></div><div class="ph-sub">See where everything's happening 📍</div></div><span class="ph-chip" id="mapCount">—</span></div>
      <div class="sc" style="overflow:hidden;"><div id="map"></div></div>
    </div>

    <!-- ── SQUAD ── -->
    <div class="view" id="view-users-view">
      <div class="ph su"><div><div class="ph-title">The <strong>Squad</strong></div><div class="ph-sub">Everyone vibing on Krowdly 🌟</div></div><span class="ph-chip" id="usersCount">—</span></div>
      <div class="sc"><div class="sc-head"><span class="sc-title">All Members</span></div><div class="sc-body"><div class="users-grid" id="usersGrid"><div class="es"><span class="ei">👥</span>No members yet</div></div></div></div>
    </div>

    <!-- ── PROFILE / CUSTOMIZER ── -->
    <div class="view" id="view-profile-view">
      <div class="ph su"><div><div class="ph-title">My <strong>Profile</strong></div><div class="ph-sub">Customize your Krowdly experience</div></div></div>
      <div class="profile-panel">
        <!-- Left: profile card -->
        <div class="profile-sidebar-card su1">
          <div class="profile-cover" id="profileCoverBg">
            <div class="profile-cover-inner"></div>
          </div>
          <div style="padding:0 20px;">
            <div class="profile-av-wrap">
              <img class="profile-av" id="bigProfileAv" src="" alt="">
              <div class="profile-av-edit" onclick="document.getElementById('bigAvInput').click()">✏️<input type="file" id="bigAvInput" accept="image/*" style="display:none;"></div>
            </div>
          </div>
          <div class="profile-info">
            <div class="profile-name-edit" id="profileBigName" contenteditable="false"></div>
            <div class="profile-handle" id="profileHandle">@krowdie</div>
            <div class="profile-bio" id="profileBioDisplay">Tap to set your bio</div>
            <button class="btn btn-o btn-sm" id="editProfileBtn">Edit Profile</button>
          </div>
          <div class="profile-stats-row">
            <div class="p-stat"><div class="p-stat-n" id="pStatEvents">0</div><div class="p-stat-l">Events</div></div>
            <div class="p-stat"><div class="p-stat-n" id="pStatGoing">0</div><div class="p-stat-l">Going</div></div>
            <div class="p-stat"><div class="p-stat-n" id="pStatBadges">3</div><div class="p-stat-l">Badges</div></div>
          </div>
        </div>

        <!-- Right: tabs -->
        <div class="profile-main-card su2">
          <div class="profile-tabs">
            <button class="p-tab active" onclick="switchProfileTab('customize')">Customize</button>
            <button class="p-tab" onclick="switchProfileTab('my-events')">My Events</button>
            <button class="p-tab" onclick="switchProfileTab('badges')">Badges</button>
            <button class="p-tab" onclick="switchProfileTab('settings')">Settings</button>
          </div>

          <!-- Customize -->
          <div class="p-tab-body active" id="ptab-customize">
            <div class="customizer-grid">
              <div class="cust-section" style="grid-column:1/-1;">
                <h4>Avatar</h4>
                <div class="av-grid" id="custAvGrid"></div>
              </div>
              <div class="cust-section">
                <h4>Profile Color</h4>
                <div class="color-grid" id="custColorGrid"></div>
              </div>
              <div class="cust-section">
                <h4>Bio</h4>
                <textarea id="custBio" style="width:100%;padding:10px;border-radius:var(--r2);border:1.5px solid var(--bg3);background:var(--bg);font-family:'Outfit',sans-serif;font-size:0.84rem;color:var(--ink);resize:none;min-height:80px;outline:none;" placeholder="Tell the squad about yourself…" maxlength="160"></textarea>
                <button class="btn btn-p btn-sm" style="margin-top:8px;width:100%;justify-content:center;" onclick="saveBio()">Save Bio</button>
              </div>
              <div class="cust-section">
                <h4>Display Name</h4>
                <input id="custName" style="width:100%;padding:10px 12px;border-radius:var(--r2);border:1.5px solid var(--bg3);background:var(--bg);font-family:'Outfit',sans-serif;font-size:0.88rem;color:var(--ink);outline:none;" placeholder="Your display name">
                <button class="btn btn-p btn-sm" style="margin-top:8px;width:100%;justify-content:center;" onclick="saveName()">Update Name</button>
              </div>
            </div>
          </div>

          <!-- My Events -->
          <div class="p-tab-body" id="ptab-my-events">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
              <div style="font-size:0.8rem;color:var(--ink3);font-weight:500;">Your hosted events</div>
              <button class="btn btn-p btn-sm" onclick="navTo('create-view')">+ New Event</button>
            </div>
            <div class="my-events-list" id="myEventsList">
              <div class="es"><span class="ei">🎪</span>No events yet<p>Host your first event!</p></div>
            </div>
          </div>

          <!-- Badges -->
          <div class="p-tab-body" id="ptab-badges">
            <div style="font-size:0.8rem;color:var(--ink3);margin-bottom:16px;font-weight:500;">Earn badges by being active on Krowdly</div>
            <div class="badge-display" id="badgeDisplay"></div>
          </div>

          <!-- Settings -->
          <div class="p-tab-body" id="ptab-settings">
            <div style="display:flex;flex-direction:column;gap:14px;">
              <div class="field"><label>Email Notifications</label>
                <select id="notifPref"><option value="all">All activity</option><option value="mentions">Mentions only</option><option value="none">None</option></select>
              </div>
              <div class="field"><label>Profile Visibility</label>
                <select id="visibilityPref"><option value="public">Public</option><option value="friends">Friends only</option></select>
              </div>
              <button class="btn btn-p btn-sm" onclick="saveSettings()" style="width:fit-content;">Save Settings</button>
              <hr style="border:none;border-top:2px solid var(--bg3);margin:6px 0;">
              <button class="btn btn-sm" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;width:fit-content;" onclick="doLogout()">Sign Out</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->

  <!-- FOOTER -->
  <footer id="masthead">
    <div class="mh-stripe"></div>
    <div class="mh-inner">
      <div class="mh-hero">
        <div class="mh-logo-area">
          <div class="mh-logo-row">
            <svg width="52" height="52" viewBox="0 0 110 110" fill="none"><ellipse cx="40" cy="28" rx="15" ry="24" transform="rotate(-35 40 28)" fill="#ff2d95" opacity=".95"/><ellipse cx="68" cy="22" rx="15" ry="24" transform="rotate(25 68 22)" fill="#f97316" opacity=".95"/><ellipse cx="20" cy="58" rx="15" ry="24" transform="rotate(-65 20 58)" fill="#fbbf24" opacity=".92"/><ellipse cx="36" cy="80" rx="15" ry="24" transform="rotate(-15 36 80)" fill="#10b981" opacity=".92"/><ellipse cx="64" cy="86" rx="15" ry="24" transform="rotate(20 64 86)" fill="#06b6d4" opacity=".92"/><ellipse cx="90" cy="58" rx="15" ry="24" transform="rotate(65 90 58)" fill="#3b82f6" opacity=".92"/><ellipse cx="76" cy="32" rx="14" ry="22" transform="rotate(10 76 32)" fill="#a855f7" opacity=".88"/><ellipse cx="52" cy="50" rx="12" ry="18" fill="rgba(230,180,255,0.7)"/></svg>
            <div class="mh-logo-name">Krowdly</div>
          </div>
          <div class="mh-tagline">Where your city comes alive — discover events, meet your squad, and make every day count.</div>
          <div class="mh-pills"><span class="mh-pill">✨ Real-time</span><span class="mh-pill">📍 Location-aware</span><span class="mh-pill">🤝 Squad-first</span><span class="mh-pill">🚀 Always live</span></div>
        </div>
        <div class="mh-links">
          <div class="mh-lg"><h4>Explore</h4><a href="#">Discover</a><a href="#">Host Events</a><a href="#">Live Map</a><a href="#">Squad</a></div>
          <div class="mh-lg"><h4>Company</h4><a href="#">About</a><a href="#">Blog</a><a href="#">Join Us</a><a href="#">Press</a></div>
          <div class="mh-lg"><h4>Legal</h4><a href="#">Privacy</a><a href="#">Terms</a><a href="#">Cookies</a><a href="#">Safety</a></div>
        </div>
      </div>
      <div class="mh-bottom">
        <div class="mh-copy">© 2026 Krowdly · <span>Uncertainty Industries</span></div>
        <div class="mh-builder"><div class="mh-builder-av">OC</div><div class="mh-builder-text"><span class="mh-builder-built">CEO</span><span class="mh-builder-name">Otubu Christopher</span></div></div>
        <div class="mh-social"><div class="mh-soc-btn">𝕏</div><div class="mh-soc-btn"><svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="1" fill="currentColor" stroke="none"/></svg></div><div class="mh-soc-btn">♪</div></div>
      </div>
    </div>
  </footer>
</div>

<!-- ══════════════ AUTH MODAL ══════════════ -->
<div class="ov" id="authModal">
  <div class="mo">
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
      <button class="auth-tab" id="tabSignin" onclick="switchAuthTab('signin')">Sign In</button>
    </div>

    <!-- Sign Up -->
    <div id="panelSignup">
      <div class="mo-eyebrow" style="margin-top:18px;">Create your account ✨</div>
      <h2>Join the Squad</h2>
      <p>Start discovering events and connecting with your city.</p>
      <div class="av-picker-label">Choose your avatar</div>
      <div class="av-picker" id="avPicker"></div>
      <div class="field" style="margin-bottom:13px;"><label>Display Name</label><input id="suName" placeholder="e.g. Tunde Okonkwo" maxlength="40" autocomplete="name"></div>
      <div class="field" style="margin-bottom:13px;"><label>Email</label><input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email"></div>
      <div class="field" style="margin-bottom:5px;"><label>Password</label><div class="pw-wrap"><input id="suPassword" type="password" placeholder="Min 6 characters" autocomplete="new-password"><button class="pw-eye" onclick="togglePw('suPassword',this)" type="button">👁</button></div></div>
      <div class="pw-strength" id="suStrength"></div>
      <div class="mo-actions"><button class="btn btn-p" id="signupBtn" style="flex:1;">Create Account</button><button class="btn btn-g" id="modalCancelBtn">Cancel</button></div>
      <div class="auth-switch">Already have an account? <span onclick="switchAuthTab('signin')">Sign in →</span></div>
    </div>

    <!-- Sign In -->
    <div id="panelSignin" style="display:none;">
      <div class="mo-eyebrow" style="margin-top:18px;">Welcome back 👋</div>
      <h2>Sign In</h2>
      <p>Good to see you again. Jump back in.</p>
      <div class="field" style="margin-bottom:13px;"><label>Email</label><input id="siEmail" type="email" placeholder="you@example.com" autocomplete="email"></div>
      <div class="field" style="margin-bottom:5px;"><label>Password</label><div class="pw-wrap"><input id="siPassword" type="password" placeholder="Your password" autocomplete="current-password"><button class="pw-eye" onclick="togglePw('siPassword',this)" type="button">👁</button></div></div>
      <div class="mo-actions"><button class="btn btn-p" id="signinBtn" style="flex:1;">Sign In</button><button class="btn btn-g" id="modalCancelBtn2">Cancel</button></div>
      <div class="auth-switch">No account? <span onclick="switchAuthTab('signup')">Sign up →</span></div>
    </div>
  </div>
</div>


<!-- ══════════════ CONFIG MODAL ══════════════ -->
<div id="configModal">
  <div class="cfg-box">
    <div class="cfg-eyebrow">One-time setup ⚙️</div>
    <h2>Connect Your Backend</h2>
    <p>Paste your Vercel backend URL and Supabase keys below. They're saved in your browser — you only do this once.</p>
    <div id="cfgStatus" class="cfg-status"></div>
    <div class="cfg-fields">
      <div class="cfg-field">
        <label>Backend URL (Vercel)</label>
        <input id="cfgBackend" placeholder="https://your-app.vercel.app" autocomplete="off">
        <div class="cfg-hint">Your deployed Vercel URL — no trailing slash. <a href="https://vercel.com/dashboard" target="_blank">Open Vercel →</a></div>
      </div>
      <div class="cfg-field">
        <label>Supabase Project URL</label>
        <input id="cfgSupabaseUrl" placeholder="https://xxxxx.supabase.co" autocomplete="off">
        <div class="cfg-hint">Found in <a href="https://app.supabase.com" target="_blank">Supabase Dashboard</a> → Project Settings → API</div>
      </div>
      <div class="cfg-field">
        <label>Supabase Anon / Public Key</label>
        <input id="cfgSupabaseAnon" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." autocomplete="off">
        <div class="cfg-hint">The <strong>anon public</strong> key (not the service key). Same page as above.</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn btn-p" id="cfgTestBtn" style="flex:1;justify-content:center;">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Test &amp; Save
      </button>
      <button class="btn btn-g" id="cfgSkipBtn">Skip for now</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<!-- ══════════════ JAVASCRIPT ══════════════ -->
<script>
// ── Config — loaded from localStorage so you never need to edit this file ──
let BACKEND_URL   = localStorage.getItem('https://krowdly.vercel.app')  || '';
let SUPABASE_URL  = localStorage.getItem('https://rvysiglrggezxfxaxmgq.supabase.co') || '';
let SUPABASE_ANON = localStorage.getItem('eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2eXNpZ2xyZ2dlenhmeGF4bWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTI5MTAsImV4cCI6MjA4NzQyODkxMH0.QuvbHswjV-Az7JqDzWL2uxhDtCUu_bAz3HVPbO92FSQ')|| '';
const SWATCHES = ['#ff2d95','#a855f7','#3b82f6','#06b6d4','#10b981','#fbbf24','#f97316'];
const PROFILE_COLORS = ['#ff2d95','#a855f7','#3b82f6','#06b6d4','#10b981','#fbbf24','#f97316','#ec4899'];
const AV_SEEDS = ['Krowdly1','Lagos2','Abuja3','Squad4','Vibe5','Energy6','Neon7','Pulse8'];
const BADGES_DEF = [
  {id:'first',label:'First Event 🎉',desc:'Hosted your first event',earned:false},
  {id:'social',label:'Social Butterfly 🦋',desc:'Messaged 5 people',earned:false},
  {id:'explorer',label:'Explorer 🗺️',desc:'RSVPd 3 events',earned:false},
  {id:'creator',label:'Creator ✨',desc:'Hosted 3 events',earned:false},
  {id:'squad',label:'Squad Goals 👥',desc:'100 RSVPs on an event',earned:false},
  {id:'verified',label:'Verified ✓',desc:'Completed your profile',earned:true},
  {id:'early',label:'Early Adopter ⚡',desc:'Joined in 2026',earned:true},
  {id:'krowdie',label:'Krowdie 🌟',desc:'Core community member',earned:true},
];

let sbClient=null, sbRealtime=null, user=null, events=[], allUsers=[], categories=[], activeCategory=null;
let rsvps=new Set(), chatRecipient=null, typingTimeout=null, unreadCounts={};
let myLocation=null, map=null, markers=[];
let selectedAvatar='', selectedProfileColor='#a855f7';
let eventTags=[], selectedPrivacy='public', uploadedImageDataUrl='';
let userProfile = {};

// ──────────── INIT ────────────
document.addEventListener('DOMContentLoaded', ()=>{
  applyTheme();
  initSupabaseRealtime();
  loadUser();
  loadCategories();
  initListeners();
  initMap();
  initSearch();
  requestLocation();
  fetchEvents();
  fetchUsers();
  buildCustColorGrid();
});

// ──────────── THEME ────────────
function applyTheme(){
  const s=localStorage.getItem('krowdlyTheme')||'vibrant';
  document.documentElement.setAttribute('data-theme',s);
  updateThemeIcon(s);
}
function updateThemeIcon(theme){
  const isDark=theme==='dark';
  const sun=document.getElementById('themeIconSun');
  const moon=document.getElementById('themeIconMoon');
  if(sun) sun.style.display=isDark?'':'none';
  if(moon) moon.style.display=isDark?'none':'';
  // sidebar theme btns
  const sbIcons=['themeToggle','themeToggleGuest'];
  sbIcons.forEach(id=>{
    const el=document.getElementById(id);
    if(!el) return;
    el.innerHTML = isDark
      ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>'
      : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
  });
}
function toggleTheme(){
  const cur=document.documentElement.getAttribute('data-theme')||'vibrant';
  const next=cur==='dark'?'vibrant':'dark';
  document.documentElement.setAttribute('data-theme',next);
  localStorage.setItem('krowdlyTheme',next);
  updateThemeIcon(next);
}

// ──────────── SIDEBAR ────────────
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('sb-overlay').classList.add('vis');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('sb-overlay').classList.remove('vis');}

// ──────────── CHAT POPOUT ────────────
function openChat(){document.getElementById('chat-popout').classList.add('open');}
function closeChat(){document.getElementById('chat-popout').classList.remove('open');}

// ──────────── SOCKET ────────────
// ──────────── SUPABASE REALTIME (replaces Socket.io — works on Vercel) ────────────
function initSupabaseRealtime(){
  try{
    sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    if(!sbClient) return;

    // ── Events table: live event feed ──
    sbClient.channel('events-channel')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'events'}, payload=>{
        const ev = payload.new;
        if(!events.find(e=>e.id===ev.id)) events.unshift(ev);
        renderEvents();
        addActivity({type:'eventPosted',user:ev.host,action:`posted "${ev.name}"`,timestamp:ev.created_at});
      })
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'events'}, payload=>{
        const ev=payload.new;
        const i=events.findIndex(e=>e.id===ev.id);
        if(i>=0)events[i]=ev; else events.unshift(ev);
        renderEvents();
      })
      .on('postgres_changes',{event:'DELETE',schema:'public',table:'events'}, payload=>{
        events=events.filter(e=>e.id!==payload.old.id);
        renderEvents();
      })
      .subscribe();

    // ── Users table: online presence ──
    sbClient.channel('users-channel')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'users'}, payload=>{
        const u=payload.new;
        if(!allUsers.find(x=>x.id===u.id)) allUsers.unshift(u);
        renderUsers();updateChatUserList();
        addActivity({type:'userJoined',user:u.username,action:'just joined Krowdly 🎉',timestamp:u.created_at});
      })
      .on('postgres_changes',{event:'UPDATE',schema:'public',table:'users'}, payload=>{
        const u=payload.new;
        const i=allUsers.findIndex(x=>x.id===u.id);
        if(i>=0)allUsers[i]=u; else allUsers.unshift(u);
        renderUsers();updateChatUserList();
      })
      .subscribe();

    // ── Messages table: real-time chat ──
    sbClient.channel('messages-channel')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'}, payload=>{
        const m=payload.new;
        if(!user) return;
        const myId=user.id||user._id;
        const fromMe=m.from_user===myId;
        const toMe=m.to_user===myId;
        // Show in chat if this conversation is open
        if(chatRecipient){
          const rid=chatRecipient.id||chatRecipient._id;
          if((fromMe&&m.to_user===rid)||(toMe&&m.from_user===rid)){
            displayMessage(m, fromMe);
            return;
          }
        }
        // Otherwise show unread badge
        if(toMe){
          const sid=m.from_user;
          unreadCounts[sid]=(unreadCounts[sid]||0)+1;
          updateChatUserList();updateNotifDot();
        }
      })
      .subscribe();

    // ── Typing table: typing indicators ──
    sbClient.channel('typing-channel')
      .on('postgres_changes',{event:'INSERT',schema:'public',table:'typing'}, payload=>{
        const t=payload.new;
        if(!user) return;
        if(t.to_user===(user.id||user._id)) showTyping(t.from_user);
      })
      .on('postgres_changes',{event:'DELETE',schema:'public',table:'typing'}, payload=>{
        const t=payload.old;
        if(!user) return;
        if(t.to_user===(user.id||user._id)) hideTyping(t.from_user);
      })
      .subscribe();

  }catch(e){ console.warn('Supabase Realtime unavailable:', e.message); }
}

/** Called when user types — inserts a row, then deletes it after 2s */
let typingRowId=null;
async function sendTypingSignal(to){
  if(!user||!sbClient) return;
  const myId=user.id||user._id;
  // Delete previous typing row first
  if(typingRowId){
    await sbClient.from('typing').delete().eq('id',typingRowId);
    typingRowId=null;
  }
  const {data}=await sbClient.from('typing').insert([{from_user:myId,to_user:to}]).select().single();
  if(data) typingRowId=data.id;
  clearTimeout(window._typingCleanup);
  window._typingCleanup=setTimeout(async()=>{
    if(typingRowId){ await sbClient.from('typing').delete().eq('id',typingRowId); typingRowId=null; }
  },2000);
}

// ──────────── API ────────────
async function api(path,opts={}){
  if(!BACKEND_URL){
    openConfigModal();
    throw new Error('Backend URL not set. Please configure it first.');
  }
  let res;
  try{
    res=await fetch(`${BACKEND_URL}${path}`,{
      headers:{'Content-Type':'application/json'},
      ...opts
    });
  }catch(networkErr){
    // "Failed to fetch" = network error (CORS, server down, wrong URL)
    throw new Error('Cannot reach server. Check your BACKEND_URL and make sure CORS allows your domain.');
  }
  if(!res.ok){
    // Try to read the backend's error message (e.g. "Email already registered")
    let msg=`Request failed (${res.status})`;
    try{ const body=await res.json(); msg=body.error||body.message||msg; }catch(_){}
    throw new Error(msg);
  }
  return res.json();
}
async function fetchEvents(){
  try{events=await api('/api/events');renderEvents();}
  catch(e){renderEvents();}
}
async function fetchUsers(){
  try{allUsers=await api('/api/users');renderUsers();updateChatUserList();}
  catch(e){renderUsers();}
}

// ──────────── USER AUTH ────────────
function loadUser(){
  const s=localStorage.getItem('krowdlyUser');
  if(s){try{user=JSON.parse(s);if(!user._id)user._id=user.id;userProfile=JSON.parse(localStorage.getItem('krowdlyProfile')||'{}');updateAuthUI();}catch(e){localStorage.removeItem('krowdlyUser');}}
}
function saveUser(u){
  user=u;if(!user._id)user._id=user.id;
  localStorage.setItem('krowdlyUser',JSON.stringify(u));
  updateAuthUI();
}
function updateAuthUI(){
  const btn=document.getElementById('authBtn');
  if(user){
    btn.textContent='My Profile';btn.classList.add('li');btn.classList.remove('authBtn-pulse');
    document.getElementById('sbLoggedIn').style.display='block';
    document.getElementById('sbGuest').style.display='none';
    document.getElementById('profileNavWrap').style.display='block';
    const name=user.username||user.name||'User';
    const av=user.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(name)}`;
    document.getElementById('profileName').textContent=name;
    document.getElementById('profileAvatar').src=av;
    document.getElementById('bigProfileAv').src=av;
    document.getElementById('profileBigName').textContent=name;
    document.getElementById('profileHandle').textContent='@'+name.toLowerCase().replace(/\s/g,'');
    document.getElementById('custName').value=name;
    const bio=userProfile.bio||'';
    document.getElementById('profileBioDisplay').textContent=bio||'Tap to set your bio';
    document.getElementById('custBio').value=bio;
    // apply cover color
    const col=userProfile.color||selectedProfileColor;
    document.getElementById('profileCoverBg').style.background=`linear-gradient(135deg,${col},${col}88)`;
    updateMyEventsList();
    updateBadges();
    updateProfileStats();
  } else {
    btn.textContent='Sign Up';btn.classList.remove('li');btn.classList.add('authBtn-pulse');
    document.getElementById('sbLoggedIn').style.display='none';
    document.getElementById('sbGuest').style.display='flex';
    document.getElementById('profileNavWrap').style.display='none';
  }
}
function doLogout(){
  if(user){
    const uid=user.id||user._id;
    api('/api/auth/signout',{method:'POST',body:JSON.stringify({userId:uid})}).catch(()=>{});
  }
  localStorage.removeItem('krowdlyUser');
  user=null;rsvps.clear();
  updateAuthUI();renderEvents();closeSidebar();
  navTo('discover');toast('Logged out! See you later ✌️');
}

// ──────────── NAV ────────────
function navTo(viewId){
  document.querySelectorAll('.ni[data-view]').forEach(b=>b.classList.toggle('active',b.getAttribute('data-view')===viewId));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el=document.getElementById('view-'+viewId);
  if(el) el.classList.add('active');
  if(viewId==='map-view'&&map) setTimeout(()=>map.invalidateSize(),150);
  closeSidebar();
}

// ──────────── LISTENERS ────────────
function initListeners(){
  document.getElementById('menuBtn').addEventListener('click',openSidebar);
  document.getElementById('sidebarClose').addEventListener('click',closeSidebar);
  document.getElementById('sb-overlay').addEventListener('click',closeSidebar);
  document.getElementById('topbarChatBtn').addEventListener('click',()=>document.getElementById('chat-popout').classList.contains('open')?closeChat():openChat());
  document.getElementById('chatClose').addEventListener('click',closeChat);
  document.getElementById('chatNavBtn').addEventListener('click',()=>{closeSidebar();openChat();switchChatTab('messages');});

  document.getElementById('authBtn').addEventListener('click',()=>{
    if(user) navTo('profile-view');
    else openAuthModal('signup');
  });
  document.getElementById('logoutBtn').addEventListener('click',doLogout);

  // Nav items
  document.querySelectorAll('.ni[data-view]').forEach(btn=>{
    btn.addEventListener('click',()=>navTo(btn.getAttribute('data-view')));
  });

  // Auth
  document.getElementById('signupBtn').addEventListener('click',doSignup);
  document.getElementById('signinBtn').addEventListener('click',doSignin);
  document.getElementById('modalCancelBtn').addEventListener('click',closeAuthModal);
  document.getElementById('modalCancelBtn2').addEventListener('click',closeAuthModal);
  document.getElementById('authModal').addEventListener('click',e=>{if(e.target===document.getElementById('authModal'))closeAuthModal();});
  document.getElementById('suPassword').addEventListener('input',e=>{const s=pwStrength(e.target.value);const bar=document.getElementById('suStrength');bar.innerHTML=s.score?`<div class="pw-sf" style="width:${s.pct}%;background:${s.color};"></div>`:''});
  ['suPassword','siPassword'].forEach((id,i)=>document.getElementById(id).addEventListener('keypress',e=>{if(e.key==='Enter')(i===0?document.getElementById('signupBtn'):document.getElementById('signinBtn')).click();}));

  // Theme
  ['themeToggle','themeToggleGuest','topbarThemeBtn'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('click',toggleTheme);});

  // Post event
  document.getElementById('postBtn').addEventListener('click',doPostEvent);

  // Privacy toggle
  document.querySelectorAll('.priv-opt').forEach(opt=>{
    opt.addEventListener('click',()=>{
      document.querySelectorAll('.priv-opt').forEach(o=>o.classList.remove('sel'));
      opt.classList.add('sel');
      selectedPrivacy=opt.getAttribute('data-val');
    });
  });

  // Tags input
  const tagInput=document.getElementById('tagInput');
  tagInput.addEventListener('keydown',e=>{
    if(e.key==='Enter'||e.key===','){e.preventDefault();addTag(tagInput.value.trim());tagInput.value='';}
    if(e.key==='Backspace'&&tagInput.value===''&&eventTags.length){removeTag(eventTags[eventTags.length-1]);}
  });
  tagInput.addEventListener('blur',()=>{if(tagInput.value.trim())addTag(tagInput.value.trim());tagInput.value='';});
  document.getElementById('tagsWrap').addEventListener('click',()=>tagInput.focus());

  // Image upload
  document.getElementById('imgFileInput').addEventListener('change',e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      uploadedImageDataUrl=ev.target.result;
      document.getElementById('imgPreview').src=ev.target.result;
      document.getElementById('imgPreview').style.display='block';
      document.getElementById('imgUploadPrompt').style.display='none';
    };
    reader.readAsDataURL(file);
  });

  // Chat
  document.getElementById('sendMsgBtn').addEventListener('click',sendMessage);
  document.getElementById('chatInput').addEventListener('keypress',e=>{if(e.key==='Enter')sendMessage();});
  document.getElementById('chatInput').addEventListener('input',()=>{
    if(!chatRecipient||!user||!sbClient)return;
    sendTypingSignal(chatRecipient.id||chatRecipient._id);
  });

  // Category
  document.getElementById('catAddBtn').addEventListener('click',()=>{document.getElementById('cnf').classList.add('open');renderSwatches();});
  document.getElementById('catCancelBtn').addEventListener('click',()=>{document.getElementById('cnf').classList.remove('open');document.getElementById('catNameInput').value='';});
  document.getElementById('catSaveBtn').addEventListener('click',()=>{
    const name=document.getElementById('catNameInput').value.trim();
    const sel=document.querySelector('.sw.sel');
    if(!name||!sel){toast('Pick a name and color!');return;}
    categories.push({name,color:sel.style.background});
    saveCategories();document.getElementById('cnf').classList.remove('open');document.getElementById('catNameInput').value='';renderCategories();toast(`Vibe "${name}" added!`);
  });

  // Profile customizer - avatar
  buildCustAvGrid();

  // Edit profile button
  document.getElementById('editProfileBtn').addEventListener('click',()=>{navTo('profile-view');switchProfileTab('customize');});

  document.getElementById('configBtn').addEventListener('click', openConfigModal);

  // Keyboard shortcuts
  document.addEventListener('keydown',e=>{
    if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();document.getElementById('searchInput').focus();}
    if(e.key==='Escape'){closeAuthModal();closeSidebar();closeChat();}
  });
}

// ──────────── AUTH ────────────
async function doSignup(){
  const name=document.getElementById('suName').value.trim();
  const email=document.getElementById('suEmail').value.trim();
  const pass=document.getElementById('suPassword').value;
  if(!name)return shakeField('suName');
  if(!email||!email.includes('@'))return shakeField('suEmail');
  if(pass.length<6)return shakeField('suPassword');
  const btn=document.getElementById('signupBtn');
  btn.disabled=true;btn.innerHTML='<span class="sp"></span>';
  try{
    const data=await api('/api/users',{method:'POST',body:JSON.stringify({username:name,email,password:pass,avatar:selectedAvatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(name)}`})});
    saveUser(data);closeAuthModal();toast(`Welcome to Krowdly, ${name}! 🎉`);fetchUsers();
  }catch(err){
    const msg=err.message||'Sign up failed. Try again.';
    toast(msg);
    // Shake the relevant field based on what went wrong
    if(msg.toLowerCase().includes('email')) shakeField('suEmail');
    else if(msg.toLowerCase().includes('username')) shakeField('suName');
    else if(msg.toLowerCase().includes('password')) shakeField('suPassword');
    else if(msg.toLowerCase().includes('backend')||msg.toLowerCase().includes('server')||msg.toLowerCase().includes('cannot reach')){
      // Backend URL not set — show a helpful alert
      console.error('Backend config error:', msg);
    } else shakeField('suName');
  }
  finally{btn.disabled=false;btn.innerHTML='Create Account';}
}
async function doSignin(){
  const email=document.getElementById('siEmail').value.trim();
  const pass=document.getElementById('siPassword').value;
  if(!email||!email.includes('@'))return shakeField('siEmail');
  if(!pass)return shakeField('siPassword');
  const btn=document.getElementById('signinBtn');
  btn.disabled=true;btn.innerHTML='<span class="sp"></span>';
  try{
    const data=await api('/api/auth/signin',{method:'POST',body:JSON.stringify({email,password:pass})});
    saveUser(data);closeAuthModal();toast(`Welcome back, ${data.username}! 🔥`);fetchUsers();
  }catch(err){
    const msg=err.message||'Sign in failed. Try again.';
    toast(msg);
    shakeField('siEmail');shakeField('siPassword');
  }
  finally{btn.disabled=false;btn.innerHTML='Sign In';}
}

function openAuthModal(tab='signup'){document.getElementById('authModal').classList.add('open');switchAuthTab(tab);buildAvPicker();}
function closeAuthModal(){
  document.getElementById('authModal').classList.remove('open');
  ['suName','suEmail','suPassword','siEmail','siPassword'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('suStrength').innerHTML='';
}
function switchAuthTab(tab){
  document.getElementById('panelSignup').style.display=tab==='signup'?'':'none';
  document.getElementById('panelSignin').style.display=tab==='signin'?'':'none';
  document.getElementById('tabSignup').classList.toggle('active',tab==='signup');
  document.getElementById('tabSignin').classList.toggle('active',tab==='signin');
}
function buildAvPicker(){
  const p=document.getElementById('avPicker');if(p.children.length)return;
  AV_SEEDS.forEach((seed,i)=>{
    const url=`https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
    const div=document.createElement('div');div.className='av-option'+(i===0?' selected':'');
    div.innerHTML=`<img src="${url}" loading="lazy">`;
    div.addEventListener('click',()=>{document.querySelectorAll('.av-option').forEach(o=>o.classList.remove('selected'));div.classList.add('selected');selectedAvatar=url;});
    if(i===0)selectedAvatar=url;
    p.appendChild(div);
  });
}
function togglePw(id,btn){const inp=document.getElementById(id);if(inp.type==='password'){inp.type='text';btn.textContent='🙈';}else{inp.type='password';btn.textContent='👁';}}
function shakeField(id){const el=document.getElementById(id);if(!el)return;el.classList.remove('shake');void el.offsetWidth;el.classList.add('shake');el.focus();}
function pwStrength(pw){
  if(!pw)return{score:0,color:'transparent',label:'',pct:0};
  let s=0;if(pw.length>=6)s++;if(pw.length>=10)s++;if(/[A-Z]/.test(pw))s++;if(/[0-9]/.test(pw))s++;if(/[^A-Za-z0-9]/.test(pw))s++;
  return{score:s,color:['#ef4444','#f97316','#fbbf24','#10b981','#06b6d4'][s-1]||'transparent',pct:Math.min(s*20,100)};
}

// ──────────── CATEGORIES ────────────
function loadCategories(){
  const c=localStorage.getItem('krowdlyCategories');
  categories=c?JSON.parse(c):[{name:'Music',color:'#ff2d95'},{name:'Sports',color:'#10b981'},{name:'Food',color:'#fbbf24'},{name:'Gaming',color:'#a855f7'},{name:'Art',color:'#3b82f6'},{name:'Tech',color:'#06b6d4'}];
  renderCategories();
}
function saveCategories(){localStorage.setItem('krowdlyCategories',JSON.stringify(categories));}
function renderCategories(){
  const list=document.getElementById('catList');const sel=document.getElementById('evCategory');
  if(!list||!sel)return;
  list.innerHTML='';sel.innerHTML='<option value="">Select a vibe…</option>';
  categories.forEach(cat=>{
    const btn=document.createElement('button');btn.className='ci';
    btn.innerHTML=`<span class="cdot" style="background:${cat.color};color:${cat.color};"></span>${cat.name}<button class="cat-del" type="button" aria-label="delete">×</button>`;
    btn.querySelector('.cat-del').addEventListener('click',e=>{e.stopPropagation();categories=categories.filter(c=>c.name!==cat.name);if(activeCategory===cat.name)activeCategory=null;saveCategories();renderCategories();renderEvents();toast(`Vibe "${cat.name}" removed`);});
    btn.addEventListener('click',e=>{if(e.target.classList.contains('cat-del'))return;activeCategory=activeCategory===cat.name?null:cat.name;document.querySelectorAll('.ci').forEach(b=>b.classList.remove('active'));if(activeCategory)btn.classList.add('active');renderEvents();});
    list.appendChild(btn);
    const opt=document.createElement('option');opt.value=cat.name;opt.textContent=cat.name;sel.appendChild(opt);
  });
}
function renderSwatches(){
  const row=document.getElementById('swRow');if(!row)return;row.innerHTML='';
  SWATCHES.forEach((c,i)=>{const s=document.createElement('button');s.className='sw'+(i===0?' sel':'');s.style.background=c;s.title=c;s.type='button';s.addEventListener('click',()=>{document.querySelectorAll('.sw').forEach(x=>x.classList.remove('sel'));s.classList.add('sel');});row.appendChild(s);});
}

// ──────────── TAGS ────────────
function addTag(val){
  if(!val||eventTags.includes(val)||eventTags.length>=8)return;
  eventTags.push(val);renderTags();
}
function removeTag(val){eventTags=eventTags.filter(t=>t!==val);renderTags();}
function renderTags(){
  const wrap=document.getElementById('tagsWrap');const inp=document.getElementById('tagInput');
  Array.from(wrap.querySelectorAll('.tag-chip')).forEach(el=>el.remove());
  eventTags.forEach(t=>{
    const chip=document.createElement('span');chip.className='tag-chip';
    chip.innerHTML=`${escHtml(t)}<button class="tag-chip-x" type="button">×</button>`;
    chip.querySelector('.tag-chip-x').addEventListener('click',()=>removeTag(t));
    wrap.insertBefore(chip,inp);
  });
}

// ──────────── EVENTS ────────────
async function doPostEvent(){
  if(!user)return toast('Sign in to host events!');
  const title=document.getElementById('evTitle').value.trim();
  const loc=document.getElementById('evLocation').value.trim();
  const cat=document.getElementById('evCategory').value;
  const date=document.getElementById('evDate').value;
  if(!title)return shakeFieldEl(document.getElementById('evTitle'));
  if(!loc)return shakeFieldEl(document.getElementById('evLocation'));
  if(!cat)return toast('Select a vibe/category!');
  if(!date)return shakeFieldEl(document.getElementById('evDate'));
  const catObj=categories.find(c=>c.name===cat);
  const btn=document.getElementById('postBtn');
  btn.disabled=true;btn.innerHTML='<span class="sp"></span> Publishing…';
  const evData={
    name:title,location:loc,category:cat,
    category_color:catObj?catObj.color:'#a855f7',
    description:document.getElementById('evDesc').value.trim(),
    date:date,time:document.getElementById('evTime').value,
    max_attendees:document.getElementById('evMax').value||null,
    tags:eventTags,privacy:selectedPrivacy,
    image:uploadedImageDataUrl||'',
    host:user.username||user.name,
    host_avatar:user.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(user.username)}`,
    lat:myLocation?.lat||0,lng:myLocation?.lng||0,
    created_by:user.id||user._id,
  };
  // Optimistic local add (works even without backend)
  const localEv={...evData,id:'local_'+Date.now(),rsvps:[]};
  if(selectedPrivacy==='public'){events.unshift(localEv);}
  saveLocalEvents();
  toast(selectedPrivacy==='public'?'Event published! 🚀 It\'s live for everyone':'Event saved as private!');
  checkBadge('first');if(events.filter(e=>e.created_by===(user.id||user._id)).length>=3)checkBadge('creator');
  // Reset form
  ['evTitle','evDesc','evLocation','evDate','evTime','evMax'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  eventTags=[];renderTags();uploadedImageDataUrl='';
  document.getElementById('imgPreview').style.display='none';
  document.getElementById('imgUploadPrompt').style.display='block';
  document.getElementById('imgFileInput').value='';
  selectedPrivacy='public';document.querySelectorAll('.priv-opt').forEach(o=>{o.classList.toggle('sel',o.getAttribute('data-val')==='public');});
  // Try backend
  try{await api('/api/events',{method:'POST',body:JSON.stringify(evData)});}catch(e){}
  btn.disabled=false;btn.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> Publish Event';
  navTo('discover');updateMyEventsList();updateProfileStats();
}

function saveLocalEvents(){localStorage.setItem('krowdlyLocalEvents',JSON.stringify(events.filter(e=>String(e.id).startsWith('local_'))));}
function loadLocalEvents(){
  const s=localStorage.getItem('krowdlyLocalEvents');
  if(s){try{const local=JSON.parse(s);local.forEach(ev=>{if(!events.find(e=>e.id===ev.id))events.unshift(ev);});}catch(e){}}
}

function renderEvents(){
  loadLocalEvents();
  let filtered=activeCategory?events.filter(e=>e.category===activeCategory):events;
  // Only show public events to non-owners, or all to the owner
  filtered=filtered.filter(e=>e.privacy!=='private'||(user&&(e.created_by===(user.id||user._id))));
  const grid=document.getElementById('eventGrid');if(!grid)return;
  grid.innerHTML='';
  if(filtered.length===0){
    const conn=!!BACKEND_URL;
    grid.innerHTML=conn?'<div class="es"><span class="ei">✨</span>No events yet<p>Be the first to create one!</p></div>':'<div class="es"><span class="ei">✨</span>No events yet<p>Create one using "Host Events" in the menu!</p></div>';
  }else{filtered.forEach(e=>grid.appendChild(createEventCard(e)));}
  const st=document.getElementById('statTotal');if(st)st.textContent=filtered.length;
  const sa=document.getElementById('statAttending');if(sa)sa.textContent=rsvps.size;
  const sm=document.getElementById('statMembers');if(sm)sm.textContent=allUsers.length||'—';
  const mc=document.getElementById('mapCount');if(mc)mc.textContent=`${filtered.length} Events`;
  const fc=document.getElementById('filteredChip');
  if(fc){fc.textContent=activeCategory?`${filtered.length} in ${activeCategory}`:'';fc.style.display=activeCategory?'inline-block':'none';}
  updateMap();
}

function createEventCard(e){
  const card=document.createElement('div');card.className='ev-card';
  const color=e.category_color||e.categoryColor||'#a855f7';
  card.style.setProperty('--cat-c',color);
  const going=rsvps.has(e.id);
  const cnt=Array.isArray(e.rsvps)?e.rsvps.length:(e.rsvpCount||0);
  const av=e.host_avatar||e.hostAvatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(e.host||'host')}`;
  const dateStr=e.date?new Date(e.date).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';
  const privBadge=`<span class="ev-privacy ${e.privacy==='private'?'prv':'pub'}">${e.privacy==='private'?'🔒 Private':'🌍 Public'}</span>`;
  const tagsHtml=(e.tags||[]).slice(0,3).map(t=>`<span class="ev-tag">${escHtml(t)}</span>`).join('');
  let imgHtml='';
  if(e.image){imgHtml=`<img class="ev-img" src="${e.image}" alt="${escHtml(e.name)}" onerror="this.style.display='none'">`;}
  else{imgHtml=`<div class="ev-img-placeholder"><span style="position:relative;z-index:1;">🎪</span></div>`;}

  card.innerHTML=`
    <div class="ev-card-bar"></div>
    ${imgHtml}
    <div class="ev-body">
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <div class="ev-badge" style="background:${color};"><span class="ev-badge-dot"></span>${escHtml(e.category||'Event')}</div>
        ${privBadge}
        ${dateStr?`<span style="font-size:0.66rem;color:var(--ink3);font-weight:600;margin-left:auto;">${dateStr}</span>`:''}
      </div>
      <div class="ev-title">${escHtml(e.name||'Untitled')}</div>
      <div class="ev-meta"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>${escHtml(e.location||'TBA')}</div>
      ${e.description?`<div class="ev-desc">${escHtml(e.description)}</div>`:''}
      ${tagsHtml?`<div class="ev-tags">${tagsHtml}</div>`:''}
    </div>
    <div class="ev-footer">
      <div class="host-row"><img class="h-av" src="${av}" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback'"><span class="h-name">${escHtml(e.host||'Unknown')}</span></div>
      <div class="ev-actions">
        <span class="rsvp-count"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>${cnt}</span>
        <button class="btn-rsvp ${going?'going':''}">${going?'Going ✓':'RSVP'}</button>
      </div>
    </div>`;
  card.querySelector('.btn-rsvp').addEventListener('click',()=>toggleRSVP(e.id));
  return card;
}

async function toggleRSVP(id){
  if(!user)return toast('Sign in to RSVP!');
  const going=rsvps.has(id);
  going?rsvps.delete(id):rsvps.add(id);
  const ev=events.find(e=>e.id===id);
  if(ev){ev.rsvps=ev.rsvps||[];if(!going)ev.rsvps.push(user.id||user._id);else ev.rsvps=ev.rsvps.filter(r=>r!==(user.id||user._id));}
  toast(going?'RSVP removed':'You\'re going! 🎉');renderEvents();
  if(rsvps.size>=3)checkBadge('explorer');
  updateProfileStats();
  try{await api(`/api/events/${id}/rsvp`,{method:'POST',body:JSON.stringify({userId:user.id||user._id,username:user.username})});}catch(e){}
}

// ──────────── USERS ────────────
function renderUsers(){
  const grid=document.getElementById('usersGrid');if(!grid)return;
  grid.innerHTML='';
  const uc=document.getElementById('usersCount');if(uc)uc.textContent=allUsers.length?allUsers.length+' Members':'—';
  if(allUsers.length===0){grid.innerHTML='<div class="es"><span class="ei">👥</span>No members yet<p>Sign up to be the first!</p></div>';return;}
  allUsers.forEach(u=>grid.appendChild(createUserCard(u)));
}
function createUserCard(u){
  const card=document.createElement('div');card.className='user-card';
  const av=u.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(u.username||'user')}`;
  card.innerHTML=`<div class="uav-wrap"><img src="${av}" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback'" ${u.online?'style="border-color:var(--gr);box-shadow:0 0 0 3px rgba(16,185,129,0.25);"':''}>${u.online?'<div class="u-odot"></div>':''}</div><div class="uname">${escHtml(u.username||'User')}</div><div class="umeta">${u.online?'🟢 Online':'⚫ Offline'}</div><div style="display:flex;gap:8px;width:100%;"><button class="btn btn-p btn-sm" style="flex:1;justify-content:center;">Message</button></div>`;
  card.querySelector('.btn-p').addEventListener('click',()=>{if(!user)return toast('Sign in to chat!');openChatWith(u);});
  return card;
}

// ──────────── CHAT ────────────
function openChatWith(u){
  chatRecipient=u;document.getElementById('chatRLabel').textContent=u.username||'User';
  document.getElementById('chatInput').disabled=false;document.getElementById('sendMsgBtn').disabled=false;
  document.querySelectorAll('.cui').forEach(c=>c.classList.remove('active'));
  const uid=u.id||u._id;const cuiEl=document.querySelector(`.cui[data-uid="${uid}"]`);
  if(cuiEl)cuiEl.classList.add('active');
  unreadCounts[uid]=0;updateChatUserList();openChat();switchChatTab('messages');loadChatHistory(uid);
  checkBadge('social');
}
async function loadChatHistory(uid){
  const box=document.getElementById('chatBox');
  box.innerHTML='<div class="es" style="padding:14px;"><span class="ei" style="font-size:2rem;">⏳</span></div>';
  try{const myId=user.id||user._id;const msgs=await api(`/api/messages/${myId}/${uid}`);
    box.innerHTML='';
    if(!msgs.length)box.innerHTML='<div class="es" style="padding:14px;"><span class="ei" style="font-size:1.8rem;">💬</span>Start of conversation</div>';
    else msgs.forEach(m=>displayMessage(m,(m.from_user===myId||m.from===myId)));
  }catch(e){box.innerHTML='<div class="es" style="padding:14px;"><span class="ei" style="font-size:1.8rem;">💬</span>Start chatting!</div>';}
}

function sendMessage(){
  if(!chatRecipient||!user)return;
  const inp=document.getElementById('chatInput');const msg=inp.value.trim();if(!msg)return;
  inp.value='';
  const myId=user.id||user._id;
  const toId=chatRecipient.id||chatRecipient._id;
  // Optimistic display — feels instant
  displayMessage({from_user:myId,to_user:toId,message:msg,created_at:new Date().toISOString()},true);
  // Persist via REST — Supabase Realtime broadcasts the INSERT to the recipient automatically
  api('/api/messages',{method:'POST',body:JSON.stringify({from_user:myId,to_user:toId,message:msg})}).catch(()=>{});
}
function receiveMessage(m){
  if(!user)return;const myId=user.id||user._id;
  if(m.from_user===myId||m.from===myId)return;
  const sid=m.from_user||m.from;const rid=chatRecipient?chatRecipient.id||chatRecipient._id:null;
  if(chatRecipient&&sid===rid)displayMessage(m,false);
  else{unreadCounts[sid]=(unreadCounts[sid]||0)+1;updateChatUserList();updateNotifDot();}
}
function displayMessage(m,mine){
  const box=document.getElementById('chatBox');const empty=box.querySelector('.es');if(empty)empty.remove();
  const div=document.createElement('div');div.className=`msg ${mine?'mine':'theirs'}`;
  const t=new Date(m.created_at||m.timestamp||Date.now()).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
  div.innerHTML=`${!mine&&chatRecipient?`<div class="msg-sender">${escHtml(chatRecipient.username||'')}</div>`:''}${escHtml(m.message)}<div class="msg-time">${t}</div>`;
  box.appendChild(div);box.scrollTop=box.scrollHeight;
}
function showTyping(from){if(chatRecipient&&from===(chatRecipient.id||chatRecipient._id))document.getElementById('ti').classList.add('vis');}
function hideTyping(from){if(chatRecipient&&from===(chatRecipient.id||chatRecipient._id))document.getElementById('ti').classList.remove('vis');}
function updateChatUserList(){
  const list=document.getElementById('chatUserList');if(!list)return;
  list.innerHTML='';
  const myId=user?user.id||user._id:null;
  const others=allUsers.filter(u=>(u.id||u._id)!==myId);
  list.style.display=others.length?'flex':'none';
  others.forEach(u=>{
    const uid=u.id||u._id;const div=document.createElement('button');div.className='cui';div.setAttribute('data-uid',uid);
    const av=u.avatar||`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(u.username||'user')}`;
    const unread=unreadCounts[uid]||0;
    div.innerHTML=`<img src="${av}" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=fallback'">${u.online?'<div class="cui-dot"></div>':''}<span style="flex:1;text-align:left;">${escHtml(u.username||'User')}</span>${unread?`<span class="cu-badge">${unread}</span>`:''}`;
    div.addEventListener('click',()=>openChatWith(u));list.appendChild(div);
  });
  updateNotifDot();
}
function updateNotifDot(){
  const total=Object.values(unreadCounts).reduce((a,b)=>a+b,0);
  const dot=document.getElementById('chatNotifDot');if(dot)dot.classList.toggle('vis',total>0);
  const b=document.getElementById('sidebarChatBadge');if(b){b.textContent=total||'';b.style.display=total>0?'inline-block':'none';}
}
function switchChatTab(tab){
  document.getElementById('cpMsgPanel').style.display=tab==='messages'?'flex':'none';
  document.getElementById('activityPanel').style.display=tab==='activity'?'flex':'none';
  document.getElementById('activityPanel').classList.toggle('vis',tab==='activity');
  document.getElementById('cpTabMsg').classList.toggle('active',tab==='messages');
  document.getElementById('cpTabAct').classList.toggle('active',tab==='activity');
}
function addActivity(a){
  const p=document.getElementById('activityPanel');if(!p)return;
  const e=document.getElementById('actEmpty');if(e)e.remove();
  const div=document.createElement('div');div.className='ai';
  const icons={eventPosted:'🎉',eventUpdated:'✏️',userJoined:'👋',rsvpAdded:'✓'};
  div.innerHTML=`<div class="ai-ico">${icons[a.type]||'📡'}</div><div><strong>${escHtml(a.user||'')}</strong> ${escHtml(a.action||'')}<div class="ai-t">${a.timestamp?new Date(a.timestamp).toLocaleTimeString():''}</div></div>`;
  p.insertBefore(div,p.firstChild);if(p.children.length>50)p.removeChild(p.lastChild);
}

// ──────────── MAP ────────────
function initMap(){
  if(typeof L==='undefined')return;
  try{map=L.map('map').setView([6.5244,3.3792],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);}
  catch(e){console.warn('Map failed:',e);}
}
function updateMap(){
  if(!map)return;markers.forEach(m=>{try{map.removeLayer(m);}catch(e){}});markers=[];
  events.forEach(e=>{if(e.lat&&e.lng&&!isNaN(e.lat)&&!isNaN(e.lng)){try{const m=L.marker([e.lat,e.lng]).addTo(map);m.bindPopup(`<strong>${e.name||'Event'}</strong><br>${e.location||''}`);markers.push(m);}catch(e){}}});
}
function requestLocation(){
  if(!navigator.geolocation){document.getElementById('geoStatus').innerHTML='⚠️ No GPS';return;}
  document.getElementById('geoStatus').innerHTML='📍 Getting location…';
  navigator.geolocation.getCurrentPosition(pos=>{
    myLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    document.getElementById('geoStatus').innerHTML='<span style="color:var(--gr)">✓ Location set</span>';
    if(map)map.setView([pos.coords.latitude,pos.coords.longitude],13);
  },()=>{document.getElementById('geoStatus').innerHTML='⚠️ Location denied';},{timeout:10000});
}

// ──────────── SEARCH ────────────
function initSearch(){
  document.getElementById('searchInput').addEventListener('input',e=>{
    const q=e.target.value.toLowerCase().trim();if(!q){renderEvents();return;}
    const grid=document.getElementById('eventGrid');if(!grid)return;grid.innerHTML='';
    const filtered=events.filter(ev=>(ev.name||'').toLowerCase().includes(q)||(ev.location||'').toLowerCase().includes(q)||(ev.category||'').toLowerCase().includes(q)||(ev.host||'').toLowerCase().includes(q));
    if(!filtered.length)grid.innerHTML='<div class="es"><span class="ei">🔍</span>No results<p>Try a different search</p></div>';
    else filtered.forEach(ev=>grid.appendChild(createEventCard(ev)));
  });
}

// ──────────── PROFILE / CUSTOMIZER ────────────
function switchProfileTab(tab){
  document.querySelectorAll('.p-tab').forEach((t,i)=>{const tabs=['customize','my-events','badges','settings'];t.classList.toggle('active',tabs[i]===tab);});
  document.querySelectorAll('.p-tab-body').forEach(b=>b.classList.remove('active'));
  const body=document.getElementById('ptab-'+tab);if(body)body.classList.add('active');
}
function buildCustAvGrid(){
  const grid=document.getElementById('custAvGrid');if(!grid)return;grid.innerHTML='';
  AV_SEEDS.forEach(seed=>{
    const url=`https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}`;
    const div=document.createElement('div');div.className='av-opt';
    div.innerHTML=`<img src="${url}" loading="lazy">`;
    div.addEventListener('click',()=>{
      document.querySelectorAll('.av-opt').forEach(o=>o.classList.remove('sel'));
      div.classList.add('sel');
      if(user){user.avatar=url;saveUser(user);localStorage.setItem('krowdlyUser',JSON.stringify(user));updateAuthUI();toast('Avatar updated! 🎨');}
    });
    grid.appendChild(div);
  });
}
function buildCustColorGrid(){
  const grid=document.getElementById('custColorGrid');if(!grid)return;grid.innerHTML='';
  PROFILE_COLORS.forEach(c=>{
    const div=document.createElement('div');div.className='color-opt';div.style.background=c;
    div.addEventListener('click',()=>{
      document.querySelectorAll('.color-opt').forEach(o=>o.classList.remove('sel'));div.classList.add('sel');
      selectedProfileColor=c;userProfile.color=c;saveUserProfile();
      document.getElementById('profileCoverBg').style.background=`linear-gradient(135deg,${c},${c}88)`;
      toast('Profile color updated!');
    });
    grid.appendChild(div);
  });
}
function saveBio(){
  const bio=document.getElementById('custBio').value.trim();
  userProfile.bio=bio;saveUserProfile();
  document.getElementById('profileBioDisplay').textContent=bio||'Tap to set your bio';
  checkBadge('verified');toast('Bio saved!');
}
function saveName(){
  const name=document.getElementById('custName').value.trim();if(!name)return;
  if(user){user.username=name;saveUser(user);localStorage.setItem('krowdlyUser',JSON.stringify(user));updateAuthUI();toast('Name updated!');}
}
function saveSettings(){toast('Settings saved! ✓');}
function saveUserProfile(){localStorage.setItem('krowdlyProfile',JSON.stringify(userProfile));}
function updateProfileStats(){
  if(!user)return;
  const myId=user.id||user._id;
  const myEvents=events.filter(e=>e.created_by===myId||e.host===(user.username||user.name));
  document.getElementById('pStatEvents').textContent=myEvents.length;
  document.getElementById('pStatGoing').textContent=rsvps.size;
}
function updateMyEventsList(){
  const list=document.getElementById('myEventsList');if(!list)return;list.innerHTML='';
  if(!user){list.innerHTML='<div class="es"><span class="ei">🎪</span>Sign in to see your events</div>';return;}
  const myId=user.id||user._id;const name=user.username||user.name||'';
  const myEvs=events.filter(e=>e.created_by===myId||e.host===name);
  if(!myEvs.length){list.innerHTML='<div class="es"><span class="ei">🎪</span>No events yet<p>Host your first event!</p></div>';return;}
  myEvs.forEach(e=>{
    const row=document.createElement('div');row.className='my-ev-row';
    const color=e.category_color||'#a855f7';
    row.innerHTML=`<div class="my-ev-color" style="background:${color};min-width:5px;"></div><div class="my-ev-info"><div class="my-ev-name">${escHtml(e.name||'Untitled')}</div><div class="my-ev-sub">${escHtml(e.location||'')}&nbsp;·&nbsp;${e.date||''}&nbsp;·&nbsp;<span style="color:${e.privacy==='private'?'var(--pu)':'var(--gr)'}">${e.privacy==='private'?'🔒 Private':'🌍 Public'}</span></div></div><div class="my-ev-actions"><button class="icon-btn del" title="Delete">🗑</button></div>`;
    row.querySelector('.del').addEventListener('click',()=>{events=events.filter(ev=>ev.id!==e.id);saveLocalEvents();updateMyEventsList();renderEvents();toast('Event deleted');});
    list.appendChild(row);
  });
}
function updateBadges(){
  const disp=document.getElementById('badgeDisplay');if(!disp)return;disp.innerHTML='';
  BADGES_DEF.forEach(b=>{
    const el=document.createElement('div');el.className='badge'+(b.earned?' earned':'');
    el.innerHTML=`<span>${b.label}</span>`;el.title=b.desc;disp.appendChild(el);
  });
  document.getElementById('pStatBadges').textContent=BADGES_DEF.filter(b=>b.earned).length;
}
function checkBadge(id){
  const b=BADGES_DEF.find(x=>x.id===id);if(b&&!b.earned){b.earned=true;toast(`Badge unlocked: ${b.label}!`);updateBadges();}
}

// ──────────── UTILS ────────────
function shakeFieldEl(el){if(!el)return;el.classList.remove('shake');void el.offsetWidth;el.classList.add('shake');el.focus();}
function escHtml(str){if(!str)return'';const d=document.createElement('div');d.appendChild(document.createTextNode(String(str)));return d.innerHTML;}
function toast(msg){const t=document.getElementById('toast');if(!t)return;t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}

// ──────────── CONFIG MODAL ────────────
function openConfigModal(){
  // Pre-fill with whatever is saved
  document.getElementById('cfgBackend').value     = BACKEND_URL   || '';
  document.getElementById('cfgSupabaseUrl').value = SUPABASE_URL  || '';
  document.getElementById('cfgSupabaseAnon').value= SUPABASE_ANON || '';
  document.getElementById('configModal').classList.add('open');
}
function closeConfigModal(){
  document.getElementById('configModal').classList.remove('open');
}
function setCfgStatus(msg, type){
  const el=document.getElementById('cfgStatus');
  el.textContent=msg; el.className='cfg-status '+type; el.style.display='block';
}

document.addEventListener('DOMContentLoaded',()=>{
  // Test & Save button
  document.getElementById('cfgTestBtn').addEventListener('click', async ()=>{
    const backend = document.getElementById('cfgBackend').value.trim().replace(/\/+$/,'');
    const sUrl    = document.getElementById('cfgSupabaseUrl').value.trim().replace(/\/+$/,'');
    const sAnon   = document.getElementById('cfgSupabaseAnon').value.trim();

    if(!backend) return setCfgStatus('Please enter your Vercel backend URL.','err');
    if(!backend.startsWith('http')) return setCfgStatus('Backend URL must start with https://','err');

    const btn=document.getElementById('cfgTestBtn');
    btn.disabled=true; btn.innerHTML='<span class="sp"></span> Testing…';
    setCfgStatus('','');

    try{
      // Ping the health endpoint
      const res = await fetch(backend+'/', {method:'GET'});
      if(!res.ok) throw new Error('Server responded with status '+res.status);
      const data = await res.json();

      // Save everything
      BACKEND_URL   = backend;
      SUPABASE_URL  = sUrl;
      SUPABASE_ANON = sAnon;
      localStorage.setItem('krowdly_backend_url',  BACKEND_URL);
      localStorage.setItem('krowdly_supabase_url', SUPABASE_URL);
      localStorage.setItem('krowdly_supabase_anon',SUPABASE_ANON);

      setCfgStatus('✓ Connected! '+( data.status||'Backend is live.'),'ok');
      setTimeout(()=>{
        closeConfigModal();
        toast('Backend connected! You can now sign up. 🎉');
        // Re-init realtime with new keys
        if(SUPABASE_URL && SUPABASE_ANON) initSupabaseRealtime();
        fetchEvents(); fetchUsers();
      }, 1200);

    }catch(e){
      let msg = e.message||'Could not reach server.';
      if(msg.includes('Failed to fetch')||msg.includes('NetworkError')||msg.includes('Load failed')){
        msg = 'Could not reach that URL. Double-check it — make sure the backend is deployed and the URL has no typo.';
      }
      setCfgStatus('✗ '+msg,'err');
    }finally{
      btn.disabled=false;
      btn.innerHTML='<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg> Test &amp; Save';
    }
  });

  document.getElementById('cfgSkipBtn').addEventListener('click', closeConfigModal);

  // Show config modal on first load if backend not set
  if(!BACKEND_URL){
    setTimeout(openConfigModal, 800);
  }
});
</script>
</body>
</html>
