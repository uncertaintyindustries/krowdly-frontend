<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Krowdly</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#f4f6fb}

/* ---------- HEADER ---------- */
header{
  background: linear-gradient(135deg,#6c63ff,#9b72f9);
  color:#fff;
  padding:40px;
  text-align:center;
  position:relative;
  border-bottom-left-radius:20px;
  border-bottom-right-radius:20px;
}
header h1{font-size:2.5rem;margin:10px 0 5px 0;font-weight:700}
header p{opacity:.9;font-size:1.1rem}

/* ---------- TOP-RIGHT LOGIN BUTTON ---------- */
#topRightButtons{
  position:fixed;
  top:16px;
  right:20px;
  z-index:1000;
}
#topRightButtons button{
  background:#fff;
  color:#6c63ff;
  border:none;
  border-radius:12px;
  padding:10px 18px;
  font-weight:600;
  cursor:pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
#topRightButtons button:hover{
  transform:scale(1.05);
  box-shadow:0 6px 20px rgba(108,99,255,0.5);
}

/* ---------- SECTIONS ---------- */
section{
  background:#fff;
  margin:20px auto;
  padding:20px;
  max-width:1200px;
  border-radius:14px;
}
input,select,button{padding:12px;width:100%;margin:6px 0;border-radius:10px}
button{background:#6c63ff;color:white;border:none;cursor:pointer;transition:transform 0.2s}
button:hover{transform:scale(1.02)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.event{padding:16px;border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.1)}
.tag{font-size:12px;padding:4px 10px;border-radius:999px;background:#eee}
.small{font-size:13px;opacity:.7}
#map{height:400px;border-radius:14px}

/* ---------- MODALS ---------- */
.modal{
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background-color:rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
}
.modalContent{
  background:#fff;
  border-radius:16px;
  padding:30px 20px;
  max-width:400px;
  width:90%;
  text-align:center;
  position:relative;
  box-shadow:0 12px 28px rgba(0,0,0,0.3);
  animation:modalPop 0.3s ease;
}
@keyframes modalPop{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
.closeModal{
  position:absolute;
  top:12px;
  right:16px;
  font-size:1.5rem;
  cursor:pointer;
  color:#333;
}

/* ---------- AVATAR TOOLTIP ---------- */
.avatarTooltip{position:relative;display:inline-block;cursor:pointer}
.avatarTooltip .tooltipContent{
  visibility:hidden;
  width:220px;
  max-width:90vw;
  background:#fff;
  color:#333;
  text-align:left;
  border-radius:12px;
  padding:12px;
  position:absolute;
  z-index:1000;
  top:110%;
  left:50%;
  transform:translateX(-50%) translateY(-10px);
  box-shadow:0 8px 28px rgba(0,0,0,0.25);
  opacity:0;
  transition:opacity 0.3s, transform 0.3s;
  font-size:0.9rem;
}
.avatarTooltip:hover .tooltipContent{visibility:visible;opacity:1;transform:translateX(-50%) translateY(0);}
.avatarTooltip .tooltipContent a{display:inline-block;margin-right:6px;text-decoration:none;color:#fff;padding:4px 8px;border-radius:8px;font-size:0.8rem;}
.avatarTooltip .tooltipContent a.twitter{background:#1DA1F2;}
.avatarTooltip .tooltipContent a.instagram{background:#C13584;}
.avatarTooltip .tooltipContent a.linkedin{background:#0077b5;}
.avatarTooltip .tooltipContent a.facebook{background:#1877f2;}
</style>
</head>
<body>

<header>
  <h1>üéâ Krowdly</h1>
  <p>Discover events. Invite friends. Show up.</p>
</header>

<!-- Top-right login/signup button -->
<div id="topRightButtons">
  <button id="loginSignupBtn">Login / Signup</button>
</div>

<!-- USER PROFILE MODAL -->
<div id="loginModal" class="modal">
  <div class="modalContent">
    <span class="closeModal">&times;</span>
    <h2 id="loginModalTitle">Login / Signup</h2>

    <div id="loginAvatar" style="width:80px;height:80px;margin:0 auto 12px auto;border-radius:50%;background:#ccc;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#fff;">üë§</div>

    <input id="loginUsername" placeholder="Enter your username">
    <h3 style="margin-top:12px;font-size:1rem;">Profile Picture (optional)</h3>
    <input type="file" id="loginAvatarInput" accept="image/*">
    <h3 style="margin-top:12px;font-size:1rem;">Link Social Media (optional)</h3>
    <input id="loginTwitter" placeholder="Twitter URL">
    <input id="loginInstagram" placeholder="Instagram URL">
    <input id="loginLinkedIn" placeholder="LinkedIn URL">
    <input id="loginFacebook" placeholder="Facebook URL">
    <button id="loginSubmit">Submit</button>
  </div>
</div>

<!-- VIEWER PROFILE MODAL -->
<div id="profileModal" class="modal">
  <div class="modalContent">
    <span class="closeModal">&times;</span>
    <div id="modalAvatar" style="width:80px;height:80px;margin:0 auto 12px auto;border-radius:50%;background:#ccc;display:flex;align-items:center;justify-content:center;font-size:2rem;color:#fff;">üë§</div>
    <h2 id="modalUsername"></h2>
    <p id="modalBio"></p>
    <p id="modalJoined"></p>
    <p id="modalRSVP" style="font-weight:600;color:#6c63ff;"></p>
    <div id="modalSocials" class="socialIcons"></div>
    <button id="modalMessageBtn" style="margin-top:12px;background:#6c63ff;color:#fff;padding:10px 16px;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:transform 0.2s;">Message</button>
  </div>
</div>

<!-- EVENT CREATION SECTION -->
<section>
<h2>üìÖ Create Event</h2>
<input id="eventName" placeholder="Event name">
<input id="eventLocation" placeholder="Location">
<input id="eventDate" type="datetime-local">
<select id="eventCategory">
  <option>music</option>
  <option>tech</option>
  <option>food</option>
  <option>job / employment</option>
</select>
<select id="eventVisibility">
  <option value="public">üåç Public Event</option>
  <option value="private">üîí Private Event</option>
</select>
<input id="eventInviteLimit" type="number" placeholder="Invite limit (private only)">
<input type="file" id="eventImage" accept="image/*">
<input id="eventFeatures" placeholder="Event Features (comma separated)">
<button onclick="createEvent()">Create Event</button>
</section>

<!-- MAP SECTION -->
<section>
<h2>üó∫Ô∏è Event Map</h2>
<div id="map"></div>
</section>

<!-- EVENTS GRID -->
<section>
<h2>üî• Events</h2>
<div class="grid" id="events"></div>
</section>

<script>
/* ---------- STORAGE ---------- */
const load=(k,d)=>JSON.parse(localStorage.getItem(k))||d;
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

let users=load("k_users",[]);
let currentUser=load("k_user",null);
let events=load("k_events",[]);
let rsvps=load("k_rsvps",{});
let invites=load("k_invites",{});
let inviteRequests=load("k_invite_requests",{});
let eventViews=load("k_eventViews",{});

/* ---------- MAP ---------- */
const map=L.map("map").setView([20,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let markers=[];

/* ---------- USER ---------- */
function renderUser(){currentUserEl.textContent=currentUser?`Logged in as ${currentUser}`:"Not logged in";loadEvents();}
const currentUserEl=document.createElement("p");document.body.prepend(currentUserEl);renderUser();

/* ---------- LOGIN/SIGNUP MODAL ---------- */
const loginModal=document.getElementById("loginModal");
const loginSignupBtn=document.getElementById("loginSignupBtn");
const loginSubmit=document.getElementById("loginSubmit");

loginSignupBtn.onclick=()=>loginModal.style.display="flex";
loginModal.querySelector(".closeModal").onclick=()=>loginModal.style.display="none";
window.onclick=e=>{if(e.target===loginModal)loginModal.style.display="none";};

loginSubmit.onclick=()=>{
  const username=document.getElementById("loginUsername").value.trim().toLowerCase();
  if(!username) return alert("Enter a username");
  if(!users.includes(username)) users.push(username);
  currentUser=username; save("k_users",users); save("k_user",currentUser);

  const avatarInput=document.getElementById("loginAvatarInput");
  if(avatarInput.files && avatarInput.files[0]){
    const reader=new FileReader();
    reader.onload=()=>{
      const profile={
        bio:"",
        joined:new Date().toLocaleDateString(),
        avatar:reader.result,
        socialMedia:{
          twitter:document.getElementById("loginTwitter").value.trim(),
          instagram:document.getElementById("loginInstagram").value.trim(),
          linkedin:document.getElementById("loginLinkedIn").value.trim(),
          facebook:document.getElementById("loginFacebook").value.trim()
        }
      };
      save(`k_userProfile_${username}`,profile);renderUser();updateLoginButton();loginModal.style.display="none";
    };reader.readAsDataURL(avatarInput.files[0]);
  } else {
    const profile={bio:"",joined:new Date().toLocaleDateString(),avatar:null,socialMedia:{
      twitter:document.getElementById("loginTwitter").value.trim(),
      instagram:document.getElementById("loginInstagram").value.trim(),
      linkedin:document.getElementById("loginLinkedIn").value.trim(),
      facebook:document.getElementById("loginFacebook").value.trim()
    }};
    save(`k_userProfile_${username}`,profile);renderUser();updateLoginButton();loginModal.style.display="none";
  }
};

function updateLoginButton(){loginSignupBtn.textContent=currentUser?`Hi, ${currentUser}`:"Login / Signup";}

/* ---------- AVATAR HELPERS ---------- */
function getUserAvatar(username){const profile=load(`k_userProfile_${username}`,{avatar:null});return profile.avatar||null;}

/* ---------- CREATE EVENT ---------- */
function createEvent(){
  if(!currentUser) return alert("Login required");
  if(!eventName.value||!eventLocation.value||!eventDate.value) return alert("Fill all fields");
  const fileInput=document.getElementById("eventImage");
  navigator.geolocation.getCurrentPosition(pos=>{
    if(fileInput.files && fileInput.files[0]){
      const reader=new FileReader();
      reader.onload=()=>saveEvent(pos.coords.latitude,pos.coords.longitude,reader.result);
      reader.readAsDataURL(fileInput.files[0]);
    } else saveEvent(pos.coords.latitude,pos.coords.longitude,null);
  });
}

function saveEvent(lat,lon,img){
  events.push({id:Date.now(),name:eventName.value,location:eventLocation.value,date:eventDate.value,
    category:eventCategory.value,visibility:eventVisibility.value,inviteLimit:Number(eventInviteLimit.value)||Infinity,
    lat,lon,creator:currentUser,image:img,features:eventFeatures.value.split(",").map(f=>f.trim())});
  save("k_events",events);loadEvents();
}

/* ---------- LOAD EVENTS ---------- */
const eventsDiv=document.getElementById("events");

function loadEvents(){
  eventsDiv.innerHTML="";
  markers.forEach(m=>map.removeLayer(m));markers=[];
  events.forEach(e=>{
    const invited=invites[e.id]?.includes(currentUser);
    const joined=rsvps[e.id]?.includes(currentUser);
    const isCreator=e.creator===currentUser;
    const requested=inviteRequests[e.id]?.some(r=>r.user===currentUser);
    if(e.visibility==="private"&&!isCreator&&!invited) return;
    const canRSVP=e.visibility==="public"||invited||isCreator;

    const div=document.createElement("div");div.className="event";

    if(e.image){
      const imgEl=document.createElement("img");imgEl.src=e.image;
      imgEl.style.width="100%";imgEl.style.height="150px";imgEl.style.objectFit="cover";imgEl.style.borderRadius="12px 12px 0 0";imgEl.style.marginBottom="8px";
      div.appendChild(imgEl);
    }

    div.innerHTML+=`<span class="tag">${e.visibility==="private"?"üîí Private":"üåç Public"}</span>
      <h3>${e.name}</h3>
      <p>${e.location}</p>
      <p>${new Date(e.date).toLocaleString()}</p>`;

    if(e.features?.length) div.innerHTML+=`<p><b>Features:</b> ${e.features.join(", ")}</p>`;

    if(joined) div.innerHTML+=`<p class="small">You are attending</p>`;
    else if(canRSVP) div.innerHTML+=`<button onclick="rsvp(${e.id})">RSVP</button>`;
    else if(!requested) div.innerHTML+=`<button onclick="requestInvite(${e.id})">Request Invite</button>`;
    else div.innerHTML+=`<p class="small">Invite requested ‚è≥</p>`;

    // Creator viewers tooltip for job events
    if(e.category.toLowerCase()==="job / employment"&&isCreator){
      const tooltipDiv=document.createElement("div");tooltipDiv.className="tooltip";tooltipDiv.textContent="üëÅÔ∏è Views";
      const viewers=eventViews[e.id]||[];
      const tooltipText=document.createElement("span");tooltipText.className="tooltiptext";
      tooltipText.textContent=`${viewers.length} user${viewers.length!==1?'s':''} viewed this event`;
      tooltipDiv.appendChild(tooltipText);
      div.appendChild(tooltipDiv);
    }

    // Creator avatar
    const avatarImg=document.createElement("img");
    avatarImg.src=getUserAvatar(e.creator)||"https://via.placeholder.com/40?text=üë§";
    avatarImg.style.width="40px";avatarImg.style.height="40px";avatarImg.style.borderRadius="50%";avatarImg.style.marginRight="8px";avatarImg.style.verticalAlign="middle";
    const creatorLabel=document.createElement("p");creatorLabel.style.display="flex";creatorLabel.style.alignItems="center";creatorLabel.style.margin="4px 0";
    creatorLabel.innerHTML=`Created by: ${e.creator}`;creatorLabel.prepend(avatarImg);div.appendChild(creatorLabel);

    eventsDiv.appendChild(div);

    const marker=L.marker([e.lat,e.lon]).addTo(map).bindPopup(`<b>${e.name}</b>`);markers.push(marker);
  });
}

loadEvents();

/* ---------- RSVP / INVITE ---------- */
function rsvp(id){rsvps[id]=rsvps[id]||[];if(!rsvps[id].includes(currentUser)){rsvps[id].push(currentUser);save("k_rsvps",rsvps);loadEvents();}}
function requestInvite(id){const msg=prompt("Why do you want to join?");if(!msg) return;inviteRequests[id]=inviteRequests[id]||[];if(!inviteRequests[id].some(r=>r.user===currentUser)) inviteRequests[id].push({user:currentUser,message:msg});save("k_invite_requests",inviteRequests);loadEvents();}
function approveInvite(id,user){const e=events.find(x=>x.id===id);invites[id]=invites[id]||[];if(invites[id].length>=e.inviteLimit)return alert("Invite limit reached");invites[id].push(user);inviteRequests[id]=inviteRequests[id].filter(r=>r.user!==user);save("k_invites",invites);save("k_invite_requests",inviteRequests);loadEvents();}
function declineInvite(id,user){inviteRequests[id]=inviteRequests[id].filter(r=>r.user!==user);save("k_invite_requests",inviteRequests);loadEvents();}
</script>
</body>
</html>
